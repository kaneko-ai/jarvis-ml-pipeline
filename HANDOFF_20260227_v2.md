\# JARVIS Research OS — 引き継ぎ書 v2 (HANDOFF)

\# 作成日: 2026-02-27

\# 作成元: Claude Opus 4.6 との対話セッション（2回目）



---



\## 1. プロジェクト概要



\- \*\*リポジトリ\*\*: https://github.com/kaneko-ai/jarvis-ml-pipeline

\- \*\*目的\*\*: 大学院生（PD-1/スペルミジン研究）の論文検索・分析・要約を支援するCLIツール

\- \*\*ユーザー\*\*: 個人利用（kanekiti1125）、プログラミング初学者

\- \*\*期限\*\*: 2026-04-01（研究室配属）までに実用レベルにする

\- \*\*関連リポジトリ\*\*: jarvis-desktop は\*\*凍結中\*\*（CLIに集中する方針）



---



\## 2. 環境情報



| 項目 | 値 |

|---|---|

| OS | Windows 11 |

| CPU | i7-1065G7 (4コア) |

| RAM | 16GB |

| GPU | Intel Iris Plus（GPU推論不可） |

| Python | 3.12.3 |

| venv | C:\\Users\\kaneko yu\\Documents\\jarvis-work\\jarvis-ml-pipeline\\venv |

| Git | 2.39.0.windows.2 |

| Codex CLI | 0.104.0 |

| LLM API | Gemini API (無料枠、google-genai 1.65.0) |

| LLM model | gemini-2.0-flash |

| GEMINI\_API\_KEY | 環境変数に設定済み |

| ChatGPT Plus | 利用中 |



\### venv 起動手順

```powershell

cd "C:\\Users\\kaneko yu\\Documents\\jarvis-work\\jarvis-ml-pipeline"

\& ".\\venv\\Scripts\\Activate.ps1"

Copy

3\. 現在のGitHub状態（main ブランチ）

最新コミット: 787477a4 (2026-02-27)



787477a4 fix: add summary cache, 429 retry, relax QA gate for paper\_survey (BUG-2,3)

1fb51719 fix: improve query extraction, add citations and LLM summaries (BUG-1,2,3)

65765431 fix: add run\_qa\_gate stub, .gitignore venv, add ROADMAP.md

a2b84685 fix: implement actual PubMed search in PaperFetcherAgent

a76b2b60 docs: add repo-level copilot instructions for One True Path gates

ローカルとリモートは同期済み。



4\. 動作確認済みの機能（2026-02-27 最終確認）

機能	コマンド	状態

PubMed論文検索	python -m jarvis\_cli run --goal "Search 3 recent papers about PD-1" --category paper\_survey	OK (Status: success)

クエリ抽出	\_extract\_query("Search 5 recent papers about PD-1 and summarize") → "PD-1"	OK

日本語クエリ	\_extract\_query("PD-1に関する最新の論文を10件検索して日本語で要約") → "PD-1"	OK

ステップ検出	\_detect\_step("... — Summarize findings...") → "collect"	OK

日本語要約	各論文に summary\_ja フィールド	OK（Gemini API枠内なら）

CEBMレベル	各論文に evidence\_level フィールド	OK

Citation生成	\_build\_citations() で Citation オブジェクト返却	OK

キャッシュ	\_summary\_cache でLLM重複呼び出し防止	OK

429リトライ	RESOURCE\_EXHAUSTED時に40秒待機して1回リトライ	OK

QA gate緩和	paper\_surveyカテゴリでcitations不要	OK

ログ生成	logs/runs/<run\_id>/ に10ファイル生成	OK

5\. 解決済みバグ

BUG-1: クエリ抽出の問題（解決 — コミット 1fb51719）

原因: Plannerが3サブタスクに分割 → タスクテキストにステップ説明混入 → PubMed検索失敗 → arXivフォールバック

修正: \_extract\_query() にクリーニングロジック追加、\_detect\_step() をデフォルト "collect" に固定

修正ファイル: jarvis\_core/agents.py

BUG-2: status が常に needs\_retry（解決 — コミット 1fb51719 + 787477a4）

原因: PaperFetcherAgentが citations=\[] を返す → QualityGateVerifier失敗

修正: \_build\_citations() で各論文をCitationオブジェクトに変換 + app.py でpaper\_surveyカテゴリのQA要件緩和

修正ファイル: jarvis\_core/agents.py, jarvis\_core/app.py

BUG-3: Gemini要約・エビデンスレベル未実装（解決 — コミット 1fb51719 + 787477a4）

原因: 論文メタデータのみで要約なし

修正: \_enrich\_papers\_with\_llm() でGemini API呼び出し、\_summary\_cache で重複防止、429リトライ追加

修正ファイル: jarvis\_core/agents.py

6\. 既知の残課題

BUG-4: run\_qa\_gate がスタブのまま

症状: 常に pass を返すため品質チェックが機能しない

優先度: 低（Phase 1以降で対応）

ファイル: jarvis\_core/style/\_\_init\_\_.py

Gemini API 無料枠の制限

Tier 1 = 15 RPM, 1500 RPD（日次リセット）

5論文 × 3サブタスク = 最大15回のLLM呼び出し（キャッシュで軽減済み）

大量検索（10件以上）は1日の枠を使い切る可能性あり

対策: \_summary\_cache + 429時40秒待機リトライ

ExecutionEngine の Citation 検証

ExecutionEngine.\_validate\_citations() が EvidenceStore にチャンク未登録のためCitationを弾く

現状は app.py でpaper\_surveyの QA 要件を緩和して回避

将来: EvidenceStoreへの論文登録処理を追加すれば完全なsuccess達成

7\. コードベース構造（重要ファイルと修正箇所）

jarvis-ml-pipeline/

├── jarvis\_core/

│   ├── app.py              # run\_task() — QualityGateVerifier初期化を修正済み（787477a4）

│   ├── agents.py           # PaperFetcherAgent — BUG-1,2,3全修正済み（1fb51719 + 787477a4）

│   ├── router.py           # タスクルーティング（未変更）

│   ├── llm.py              # LLMClient ラッパー（llm\_utils から再エクスポート）

│   ├── llm\_utils.py        # 実際のLLMClient実装（Gemini/Ollama/Mock）— 注: 実装はllm.pyにある

│   ├── executor.py         # ExecutionEngine（未変更）

│   ├── planner.py          # Planner — PAPER\_SURVEY を3サブタスクに分割

│   ├── bundle.py           # BundleAssembler（10ファイル契約）

│   ├── task.py             # Task, TaskCategory 定義

│   ├── registry.py         # AgentRegistry（agents.yaml読み込み）

│   ├── style/\_\_init\_\_.py   # run\_qa\_gate（現在stub）

│   ├── sources/

│   │   ├── pubmed\_client.py    # PubMedClient（動作確認済み）

│   │   ├── arxiv\_client.py     # ArxivClient

│   │   └── crossref\_client.py  # CrossrefClient

│   └── eval/

│       └── quality\_gate.py # QualityGateVerifier

├── jarvis\_cli/             # CLIエントリポイント

├── tests/                  # テスト群

├── configs/agents.yaml     # エージェント登録設定

├── ROADMAP.md              # ロードマップ

├── AGENTS.md               # AI開発ルール

└── pyproject.toml          # 依存関係定義

8\. パイプライン実行フロー（理解必須）

jarvis run --goal "..." --category paper\_survey

&nbsp; ↓

app.py: run\_task()

&nbsp; ├── Task作成（inputs={"query": goal}）

&nbsp; ├── Planner.plan() → 3サブタスク:

&nbsp; │   1. "{goal\[:50]}... — Clarify paper requirements and search keywords"

&nbsp; │   2. "{goal\[:50]}... — Collect candidate papers or sources"

&nbsp; │   3. "{goal\[:50]}... — Summarize findings against the goal"

&nbsp; ├── ExecutionEngine.run() → 各サブタスクを Router.run\_task() で実行

&nbsp; │   └── Router.\_render\_task\_text() でテキスト加工

&nbsp; │       └── PaperFetcherAgent.run\_single() が呼ばれる（3回）

&nbsp; │           ├── \_extract\_query(): キーワード抽出（BUG-1修正済み）

&nbsp; │           ├── \_detect\_step(): 常に "collect"（BUG-1修正済み）

&nbsp; │           ├── \_search\_papers(): PubMed → arXiv → Crossref

&nbsp; │           ├── \_enrich\_papers\_with\_llm(): Gemini要約（キャッシュ付き）

&nbsp; │           └── \_build\_citations(): Citationオブジェクト生成

&nbsp; ├── QualityGateVerifier.verify() — paper\_surveyではcitations不要

&nbsp; └── BundleAssembler.build() → logs/runs/<id>/ に10ファイル

9\. ロードマップ（残タスク）

Phase 0: 環境構築 ✅ 完了

Phase 0.5: バグ修正 ✅ 完了（BUG-1,2,3解決）

Phase 1: 実用化（次のターゲット）

&nbsp;P1-1: jarvis search コマンド実装（run より軽量な検索専用コマンド）

&nbsp;P1-2: Markdown保存（logs/runs/<id>/report.md の改善）

&nbsp;P1-3: BibTeX/Zotero連携

Phase 2: 高度機能

&nbsp;P2-1: Codex CLI プロバイダー統合

&nbsp;P2-2: Citation analysis

&nbsp;P2-3: PRISMA図

Phase 3: 研究準備

&nbsp;P3-1: PD-1論文100件収集

&nbsp;P3-2: スペルミジン論文50件収集

&nbsp;P3-3: 研究ノート自動生成

Phase 4: UI（4月以降）

&nbsp;P4-1: Streamlit ダッシュボード

10\. 成功の定義（2026-04-01）

Copypython -m jarvis\_cli run --goal "PD-1に関する最新の論文を10件検索して日本語で要約" --category paper\_survey



\# 期待される結果:

\# - Status: success

\# - PubMed/arXiv から PD-1 関連論文 10件

\# - 各論文に日本語要約 (summary\_ja)

\# - 各論文にエビデンスレベル (evidence\_level)

\# - logs/runs/<id>/papers.jsonl に全データ

\# - logs/runs/<id>/report.md にMarkdownレポート

11\. 重要な技術的注意点

venv は .gitignore 済み

コード作成者: ほぼ全てAI生成。ユーザーはプログラミング初学者であり、変更の理由と影響を丁寧に説明する必要がある。

google-genai vs google-generativeai: 新API (from google import genai) を使用。

UTF-8 BOM: PowerShell 5.1 は UTF-8 BOM なしファイルを Shift\_JIS と誤認する場合がある。ただし Python 3.12 は BOM 付きだと SyntaxError: invalid non-printable character U+FEFF を出すため、Python ファイルは BOM なし UTF-8 で保存すること。

12\. PowerShell + Python でのファイル編集ルール（最重要 — 必読）

❌ 絶対にやってはいけないこと

PowerShell の python -c "..." で複雑なコードを実行しない



PowerShell が \\", \\n, \\\\, $ 等を独自に解釈して壊す

特に文字列リテラル内の \\n が \\\\n に二重エスケープされる問題が発生した

引用符のネスト（"...'...\\"..\\"..'..."）は確実に壊れる

PowerShell の python -c "..." でパッチスクリプトを生成しない



@"..."@ ヒアストリングも \\n の扱いが不安定

chr() で組み立てる方法も、コードが長くなると結局エスケープ問題が発生

PowerShell の > リダイレクトでファイルを書かない



git show HASH:path > file はUTF-16で書き出し、Pythonが null bytes エラーを出す

代わりに git checkout HASH -- path を使う

Python インタラクティブモードで複数ブロックをまとめて貼らない



PowerShell がインタラクティブモード開始前に全行をPowerShellコマンドとして解釈する

if/else ブロックの直後にコメントや変数代入を続けるとSyntaxError

\_enrich\_papers\_with\_llm 内の \\n 文字列リテラルをパッチで書き換えない



文字列リテラル中の \\n は正しいPythonエスケープ（改行コード）

これを \\\\n（バックスラッシュ+n）に変えるとプロンプトが壊れる

逆に \\n を実際の改行 chr(10) に変えると文字列リテラルが壊れる

✅ 正しいやり方

パッチスクリプトは notepad ファイル名.py で作成し、python ファイル名.py で実行



メモ帳なら一切のエスケープ問題なし

AIがコードブロックを出力 → ユーザーがメモ帳にコピペ → 保存 → 実行

簡単な確認コマンド（1-2行）だけ python -c "..." で実行OK



例: python -c "import jarvis\_core.agents; print('OK')"

例: python -c "print('hello')"

ただし \\", \\n, $ を含むコードは避ける

Gitからのファイル復元は git checkout HASH -- path



> リダイレクトは使わない

Python インタラクティブモードを使う場合



PowerShell で python と入力してEnter

>>> が表示されるのを目視確認してから次のコードを貼る

各ブロックは完全に独立させる（ブロック間にコメントを入れない）

if/else の後は必ず空行を入れてから次のコードを貼る

ファイル保存のエンコーディング



Python ファイル: UTF-8（BOMなし）

Markdown ファイル: UTF-8（BOM あり/なし どちらでもOK）

pathlib.Path.write\_text(src, encoding='utf-8') を使う（BOMなし）

encoding='utf-8-sig' は使わない（BOM付きになりPythonがエラー）

13\. よくあるトラブルと対処

問題	対処

SyntaxError: invalid non-printable character U+FEFF	ファイルがUTF-8 BOMで保存されている。encoding='utf-8'で書き直す

429 RESOURCE\_EXHAUSTED	Gemini API レート制限。40秒〜1分待って再実行。日次上限に達した場合は翌日

Expecting value: line 1 column 1 (char 0)	Gemini APIが空文字列を返している。429が原因の場合が多い

type object 'PaperFetcherAgent' has no attribute '\_summary\_cache'	クラス変数定義が欠落。name = "paper\_fetcher" の直後に \_summary\_cache = {} を追加

PowerShell で Python ワンライナーが壊れる	.py ファイルに書いて python script.py で実行

git show ... > file で null bytes エラー	git checkout HASH -- path を使う

Python インタラクティブモードに入れない	PowerShellが全行をまとめて送っている。python だけを単独で入力してEnter

14\. 検証コマンド集

Copy# 環境確認

python --version

pip show google-genai



\# クエリ抽出テスト

python -c "from jarvis\_core.agents import PaperFetcherAgent; a = PaperFetcherAgent(); print(a.\_extract\_query('Search 5 recent papers about PD-1 and summarize'))"

\# 期待: PD-1



\# PubMed検索テスト

python -c "from jarvis\_core.agents import PaperFetcherAgent; a = PaperFetcherAgent(); papers, w = a.\_search\_papers('PD-1', 3); print(len(papers), \[p\['title']\[:40] for p in papers])"

\# 期待: 3 \[PD-1関連タイトル...]



\# import テスト

python -c "import jarvis\_core.agents; print('OK')"



\# 統合テスト（Gemini API使用）

python -m jarvis\_cli run --goal "Search 3 recent papers about PD-1" --category paper\_survey

\# 期待: Status: success, PD-1論文3件+日本語要約



\# 日本語統合テスト

python -m jarvis\_cli run --goal "PD-1に関する最新の論文を5件検索して日本語で要約" --category paper\_survey

15\. 今回のセッションで学んだ教訓

PowerShell のエスケープ地獄: python -c でパッチスクリプトを生成しようとして何度も失敗。最終的に notepad でファイルを作る方法が最も安全と判明。

BOM問題: encoding='utf-8-sig' で保存すると Python 3.12 が U+FEFF エラー。Python ファイルは必ず encoding='utf-8'。

git リダイレクト問題: git show > file はUTF-16になる。git checkout を使う。

バックアップの罠: .bak ファイルが想定と違うバージョンだった。復元後にコードが全部消えた。git checkout HASH -- path の方が確実。

文字列リテラルの \\n 置換は危険: パッチで \\n を chr(10) に変換したら文字列リテラルが壊れた。文字列リテラル内のエスケープは触らないこと。

Python インタラクティブモードの落とし穴: PowerShell がまとめて送信する問題、if/else 後のコメントがSyntaxErrorになる問題。

この引き継ぎ書は新しいチャットセッションの最初のメッセージとして貼り付けてください。 リポジトリURL: https://github.com/kaneko-ai/jarvis-ml-pipeline





---



保存したら、コミットもしておきましょう：



```powershell

git add HANDOFF\_20260227\_v2.md

git commit -m "docs: add handoff v2 with lessons learned"

git push origin main

