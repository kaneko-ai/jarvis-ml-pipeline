<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JARVIS Dashboard - Complete</title>
    <meta name="description" content="JARVIS Research OS - Literature Survey & Evidence Extraction Platform">
    <!-- Cloudflare Turnstile -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <style>
        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --accent: #00d4ff;
            --accent-dark: #0a9ec7;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-tab:hover,
        .nav-tab.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card) 100%);
            padding: 25px 30px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        header h1 {
            font-size: 2em;
            background: linear-gradient(135deg, var(--accent) 0%, #00ff88 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* KPI Grid - Fixed Definition (S-02) */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent);
        }

        .kpi-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--accent);
        }

        .kpi-label {
            color: var(--text-secondary);
            font-size: 0.85em;
            text-transform: uppercase;
        }

        .kpi-trend {
            font-size: 0.8em;
            margin-top: 5px;
        }

        .kpi-trend.up {
            color: var(--success);
        }

        .kpi-trend.down {
            color: var(--danger);
        }

        /* Sections */
        .section {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section h2 {
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Form Controls */
        .form-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1em;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            color: var(--accent);
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
        }

        .data-table tr:hover {
            background: rgba(0, 212, 255, 0.05);
            cursor: pointer;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: bold;
        }

        .badge-success {
            background: rgba(0, 255, 136, 0.2);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(255, 170, 0, 0.2);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(255, 68, 68, 0.2);
            color: var(--danger);
        }

        /* Search Results */
        .search-results {
            max-height: 500px;
            overflow-y: auto;
        }

        .search-result {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent);
        }

        .search-result-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .search-result-meta {
            color: var(--text-secondary);
            font-size: 0.85em;
        }

        .search-result-snippet {
            margin-top: 10px;
            font-size: 0.9em;
        }

        .highlight {
            background: rgba(0, 212, 255, 0.3);
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            border-color: var(--accent);
            background: rgba(0, 212, 255, 0.05);
        }

        .upload-zone.dragover {
            border-color: var(--success);
            background: rgba(0, 255, 136, 0.05);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--bg-card);
            margin: 50px auto;
            padding: 30px;
            border-radius: 16px;
            max-width: 900px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .modal-close {
            float: right;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-close:hover {
            color: var(--danger);
        }

        /* Progress */
        .progress-bar {
            height: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--success));
            transition: width 0.5s;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--bg-card);
            border-radius: 8px;
            border-left: 4px solid var(--accent);
            animation: slideIn 0.3s;
            z-index: 2000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--bg-secondary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        footer {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div>
                <h1>ğŸ§¬ JARVIS Research OS</h1>
                <p style="color: var(--text-secondary);">Literature Survey & Evidence Extraction Platform</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="refreshAll()">ğŸ”„ æ›´æ–°</button>
                <button class="btn btn-primary" onclick="showTab('new-query')">+ æ–°è¦ã‚¯ã‚¨ãƒª</button>
            </div>
        </header>

        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('overview')">ğŸ“Š æ¦‚è¦</div>
            <div class="nav-tab" onclick="showTab('new-query')">ğŸ” æ–°è¦ã‚¯ã‚¨ãƒª</div>
            <div class="nav-tab" onclick="showTab('search')">ğŸ“‘ æ¤œç´¢</div>
            <div class="nav-tab local-only-tab" style="display:none;" onclick="showTab('collect')">ğŸ“¥ åé›†</div>
            <div class="nav-tab local-only-tab" style="display:none;" onclick="showTab('upload')">ğŸ“ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
            <div class="nav-tab" onclick="showTab('runs')">ğŸ“‹ å®Ÿè¡Œå±¥æ­´</div>
            <span id="server-mode-indicator"
                style="margin-left:auto;padding:12px;color:var(--text-secondary);font-size:0.85em;">â˜ï¸ Serverless</span>
        </div>

        <!-- KPI Grid (S-02: Fixed Definition) -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-value" id="kpi-runs">-</div>
                <div class="kpi-label">Total Runs</div>
                <div class="kpi-trend" id="kpi-runs-trend"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpi-success">-</div>
                <div class="kpi-label">Success Rate</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="success-bar" style="width: 0%"></div>
                </div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpi-coverage">-</div>
                <div class="kpi-label">Avg Evidence Coverage</div>
                <div class="kpi-trend" id="kpi-coverage-trend"></div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpi-contract">-</div>
                <div class="kpi-label">Contract Valid</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpi-papers">-</div>
                <div class="kpi-label">Total Papers</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="kpi-claims">-</div>
                <div class="kpi-label">Total Claims</div>
            </div>
        </div>

        <!-- Tab: Overview -->
        <div id="tab-overview" class="tab-content active">
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“‹ æœ€è¿‘ã®å®Ÿè¡Œ</h2>
                </div>
                <div id="recent-runs-container">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Tab: New Query -->
        <div id="tab-new-query" class="tab-content">
            <div class="section">
                <h2>ğŸ” æ–°è¦ã‚¯ã‚¨ãƒªå®Ÿè¡Œ</h2>
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <label>æ¤œç´¢ã‚¯ã‚¨ãƒª</label>
                        <input type="text" id="query-input" placeholder="ä¾‹: CD73 immunotherapy in solid tumors">
                    </div>
                    <div class="form-group">
                        <label>æœ€å¤§è«–æ–‡æ•°</label>
                        <select id="max-papers">
                            <option value="5">5ä»¶</option>
                            <option value="10" selected>10ä»¶</option>
                            <option value="20">20ä»¶</option>
                            <option value="50">50ä»¶</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ãƒ‰ãƒ¡ã‚¤ãƒ³</label>
                        <select id="domain-select">
                            <option value="immuno_onco_preclinical">å…ç–«è…«ç˜å­¦</option>
                            <option value="antibody">æŠ—ä½“å‰µè–¬</option>
                            <option value="general">ä¸€èˆ¬</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>OAã®ã¿</label>
                        <select id="oa-only">
                            <option value="false">ã„ã„ãˆ</option>
                            <option value="true">ã¯ã„</option>
                        </select>
                    </div>
                </div>
                <!-- Turnstile Widget -->
                <div class="cf-turnstile" id="turnstile-widget" data-sitekey="0x4AAAAAACJZ1KI1ylp2m11j"
                    data-callback="onTurnstileSuccess"></div>
                <button class="btn btn-primary" id="run-query-btn" onclick="runQuery()" disabled>ğŸš€ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ</button>
                <div id="query-status" style="margin-top: 15px;"></div>
                <!-- Progress Bar -->
                <div id="progress-container" style="display: none; margin-top: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <span id="progress-stage" style="color: var(--accent); font-weight: bold;">å¾…æ©Ÿä¸­</span>
                        <span id="progress-percent" style="color: var(--text-secondary);">0%</span>
                    </div>
                    <div style="background: var(--bg-secondary); border-radius: 8px; height: 12px; overflow: hidden;">
                        <div id="progress-bar"
                            style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); transition: width 0.3s;">
                        </div>
                    </div>
                    <div id="progress-message" style="margin-top: 8px; color: var(--text-secondary); font-size: 0.9em;">
                    </div>
                    <div id="progress-counters"
                        style="margin-top: 8px; font-family: monospace; font-size: 0.85em; color: var(--text-secondary);">
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Search -->
        <div id="tab-search" class="tab-content">
            <div class="section">
                <h2>ğŸ“‘ ã‚³ãƒ¼ãƒ‘ã‚¹æ¤œç´¢ï¼ˆBM25ï¼‰</h2>
                <div class="form-row">
                    <div class="form-group" style="flex: 4;">
                        <input type="text" id="search-input" placeholder="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰...">
                    </div>
                    <button class="btn btn-primary" onclick="searchCorpus()">æ¤œç´¢</button>
                </div>
                <div id="search-results" class="search-results"></div>
            </div>
        </div>

        <!-- Tab: Collect -->
        <div id="tab-collect" class="tab-content">
            <div class="section">
                <h2>ğŸ“¥ PubMed/PMCè«–æ–‡åé›†</h2>
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <label>PubMedæ¤œç´¢ã‚¯ã‚¨ãƒª</label>
                        <input type="text" id="collect-query" placeholder="ä¾‹: CD73[Title] AND immunotherapy">
                    </div>
                    <div class="form-group">
                        <label>æœ€å¤§ä»¶æ•°</label>
                        <input type="number" id="collect-max" value="50" min="1" max="500">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" id="collect-oa" style="width: auto;">
                            OAã®ã¿
                        </label>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="collectPapers()">ğŸ“¥ åé›†é–‹å§‹</button>
                <div id="collect-status" style="margin-top: 15px;"></div>
            </div>
        </div>

        <!-- Tab: Upload -->
        <div id="tab-upload" class="tab-content">
            <div class="section">
                <h2>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                <div class="upload-zone" id="upload-zone">
                    <div style="font-size: 3em; margin-bottom: 15px;">ğŸ“¤</div>
                    <p>ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— ã¾ãŸã¯ ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                    <p style="font-size: 0.85em; color: var(--text-secondary);">PDF / BibTeX / ZIPï¼ˆæœ€å¤§100ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</p>
                </div>
                <input type="file" id="file-input" multiple accept=".pdf,.bib,.zip" style="display: none;">
                <div id="upload-status" style="margin-top: 15px;"></div>
            </div>
        </div>

        <!-- Tab: Runs -->
        <div id="tab-runs" class="tab-content">
            <div class="section">
                <div class="section-header">
                    <h2>ğŸ“‹ å…¨å®Ÿè¡Œå±¥æ­´</h2>
                    <button class="btn btn-secondary" onclick="loadRuns(this)">æ›´æ–°</button>
                </div>
                <div id="runs-table-container"></div>
            </div>
        </div>

        <!-- Run Detail Modal -->
        <div class="modal" id="run-modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal()">&times;</span>
                <div id="modal-body"></div>
            </div>
        </div>

        <footer>
            JARVIS Research OS v4.3 | 10-File Contract Compliant | KPI Fixed (S-02)
        </footer>
    </div>

    <script>
        // ===  Configuration (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã™ã‚‹) ===
        const WORKER_URL = 'https://jarvis-ml-pipeline.kanekiti1125.workers.dev'; // Serverless Mode
        const LOCAL_API_URL = 'http://127.0.0.1:8000'; // Local Server Mode (uvicorn)
        const TURNSTILE_SITE_KEY = '0x4AAAAAACJZ1KI1ylp2m11j';

        let API_BASE = WORKER_URL; // Default to serverless
        let localServerAvailable = false;
        let runs = [];
        let currentTab = 'overview';
        let turnstileToken = null;

        // === Check Local Server Availability ===
        async function checkLocalServer() {
            try {
                const res = await fetch(`${LOCAL_API_URL}/health`, { method: 'GET', mode: 'cors' });
                if (res.ok) {
                    localServerAvailable = true;
                    API_BASE = LOCAL_API_URL;
                    showToast('ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šOK (åé›†ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æœ‰åŠ¹)', 'success');
                    document.getElementById('server-mode-indicator').innerHTML = 'ğŸŸ¢ ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼';
                    // Show local-only tabs
                    document.querySelectorAll('.local-only-tab').forEach(el => el.style.display = 'block');
                }
            } catch (e) {
                localServerAvailable = false;
                API_BASE = WORKER_URL;
                document.getElementById('server-mode-indicator').innerHTML = 'â˜ï¸ Serverless';
            }
        }

        // === Tab Navigation ===
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));

            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelector(`.nav-tab[onclick="showTab('${tabId}')"]`).classList.add('active');
            currentTab = tabId;
        }

        // === KPI Update (S-02: Fixed Definition) ===
        function updateKPIs() {
            const total = runs.length;
            const successful = runs.filter(r => r.status === 'success').length;
            const contractValid = runs.filter(r => r.contract_valid).length;
            const avgCoverage = runs.length > 0
                ? runs.reduce((sum, r) => sum + (r.metrics?.evidence_coverage || 0), 0) / runs.length
                : 0;

            // Total papers/claims from all runs
            let totalPapers = 0, totalClaims = 0;
            runs.forEach(r => {
                totalPapers += r.metrics?.paper_count || 0;
                totalClaims += r.metrics?.claim_count || 0;
            });

            document.getElementById('kpi-runs').textContent = total;
            document.getElementById('kpi-success').textContent = total > 0 ? `${((successful / total) * 100).toFixed(0)}%` : '-';
            document.getElementById('kpi-coverage').textContent = `${(avgCoverage * 100).toFixed(1)}%`;
            document.getElementById('kpi-contract').textContent = `${contractValid}/${total}`;
            document.getElementById('kpi-papers').textContent = totalPapers || '-';
            document.getElementById('kpi-claims').textContent = totalClaims || '-';

            document.getElementById('success-bar').style.width = total > 0 ? `${(successful / total) * 100}%` : '0%';
        }

        // === Turnstile Callback ===
        function onTurnstileSuccess(token) {
            turnstileToken = token;
            document.getElementById('run-query-btn').disabled = false;
        }

        // === Load Runs ===
        async function loadRuns(btn = null) {
            const originalText = btn ? btn.innerText : '';
            if (btn) {
                btn.disabled = true;
                btn.innerText = 'æ›´æ–°ä¸­...';
            }

            try {
                // cache: 'no-store' to ensure we get the latest data
                const res = await fetch('runs/index.json', { cache: 'no-store' });
                if (!res.ok) {
                    if (res.status === 404) {
                        // Not found is normal for fresh deployment
                        runs = [];
                        document.getElementById('recent-runs-container').innerHTML = '<p style="color: var(--text-secondary);">å®Ÿè¡Œå±¥æ­´ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ (GitHub Pagesã®åæ˜ å¾…ã¡ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™)</p>';
                        document.getElementById('runs-table-container').innerHTML = '<p style="color: var(--text-secondary);">å®Ÿè¡Œå±¥æ­´ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
                        updateKPIs();
                        if (btn) showToast('å±¥æ­´ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“', 'info');
                        return;
                    }
                    throw new Error(`Failed to load runs/index.json: ${res.status}`);
                }

                runs = await res.json();
                renderRecentRuns();
                renderRunsTable();
                updateKPIs();
                if (btn) showToast('å±¥æ­´ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            } catch (e) {
                console.error('Failed to load runs:', e);
                document.getElementById('recent-runs-container').innerHTML = `<p style="color: var(--danger);">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`;
                if (btn) showToast('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            }
        }

        // === Render Recent Runs ===
        function renderRecentRuns() {
            const container = document.getElementById('recent-runs-container');
            if (runs.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">å®Ÿè¡Œå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            let html = '<table class="data-table"><thead><tr><th>Run ID</th><th>Timestamp</th><th>Status</th><th>Gate</th><th>Coverage</th></tr></thead><tbody>';
            runs.slice(0, 10).forEach(run => {
                const statusClass = run.status === 'success' ? 'badge-success' : run.status === 'failed' ? 'badge-danger' : 'badge-warning';
                const coverage = ((run.metrics?.evidence_coverage || 0) * 100).toFixed(1);
                html += `<tr onclick="showRunDetail('${run.run_id}')">
                    <td>${run.run_id?.substring(0, 16) || '-'}...</td>
                    <td>${run.timestamp || '-'}</td>
                    <td><span class="badge ${statusClass}">${run.status || 'unknown'}</span></td>
                    <td>${run.gate_passed ? 'âœ…' : 'âŒ'}</td>
                    <td>${coverage}%</td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // === Render Runs Table ===
        function renderRunsTable() {
            const container = document.getElementById('runs-table-container');
            if (runs.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">å®Ÿè¡Œå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            let html = '<table class="data-table"><thead><tr><th>Run ID</th><th>Timestamp</th><th>Status</th><th>Gate</th><th>Contract</th><th>Coverage</th></tr></thead><tbody>';
            runs.forEach(run => {
                const statusClass = run.status === 'success' ? 'badge-success' : run.status === 'failed' ? 'badge-danger' : 'badge-warning';
                const coverage = ((run.metrics?.evidence_coverage || 0) * 100).toFixed(1);
                html += `<tr onclick="showRunDetail('${run.run_id}')">
                    <td>${run.run_id?.substring(0, 20) || '-'}...</td>
                    <td>${run.timestamp || '-'}</td>
                    <td><span class="badge ${statusClass}">${run.status || 'unknown'}</span></td>
                    <td>${run.gate_passed ? 'âœ…' : 'âŒ'}</td>
                    <td>${run.contract_valid ? '10/10' : 'Missing'}</td>
                    <td>${coverage}%</td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // === Run Query ===
        let activeRunId = null;
        let statusPollInterval = null;

        function generateClientRunId() {
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 19).replace(/[-:T]/g, '').slice(0, 14);
            const rand = Math.random().toString(36).substring(2, 10);
            return `${timestamp}_${rand}`;
        }

        async function pollRunStatus() {
            if (!activeRunId) return;

            try {
                const res = await fetch(`${WORKER_URL}/status?run_id=${encodeURIComponent(activeRunId)}`);
                const data = await res.json();

                if (data.ok && data.status) {
                    const st = data.status;
                    document.getElementById('progress-bar').style.width = `${st.percent}%`;
                    document.getElementById('progress-percent').textContent = `${st.percent}%`;
                    document.getElementById('progress-stage').textContent = st.stage || 'processing';
                    document.getElementById('progress-message').textContent = st.message || '';

                    if (st.counters && Object.keys(st.counters).length > 0) {
                        document.getElementById('progress-counters').textContent = JSON.stringify(st.counters, null, 2);
                    }

                    if (st.percent >= 100 || st.stage === 'done' || st.stage === 'failed') {
                        clearInterval(statusPollInterval);
                        statusPollInterval = null;
                        activeRunId = null;

                        if (st.stage === 'done') {
                            showToast('ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œäº†ï¼', 'success');
                            document.getElementById('progress-stage').textContent = 'âœ… å®Œäº†';
                        } else if (st.stage === 'failed') {
                            showToast('ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å¤±æ•—', 'danger');
                            document.getElementById('progress-stage').textContent = 'âŒ å¤±æ•—';
                        }

                        // Refresh runs list
                        setTimeout(() => loadRuns(), 3000);
                    }
                }
            } catch (e) {
                console.error('Status polling error:', e);
            }
        }

        async function runQuery() {
            const query = document.getElementById('query-input').value;
            if (!query) { showToast('ã‚¯ã‚¨ãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning'); return; }
            if (!turnstileToken) { showToast('Turnstileæ¤œè¨¼ãŒå¿…è¦ã§ã™', 'warning'); return; }

            const btn = document.getElementById('run-query-btn');
            const status = document.getElementById('query-status');
            const progressContainer = document.getElementById('progress-container');

            btn.disabled = true;
            status.innerHTML = '<div class="spinner"></div><p>å®Ÿè¡Œã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ä¸­...</p>';

            // Generate client_run_id for tracking
            const clientRunId = generateClientRunId();
            activeRunId = clientRunId;

            try {
                const res = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        turnstile_token: turnstileToken,
                        action: 'pipeline',
                        query,
                        max_results: parseInt(document.getElementById('max-papers').value),
                        client_run_id: clientRunId, // Pass client_run_id to worker
                    })
                });

                if (!res.ok) {
                    let errorMessage = `Worker error: ${res.status}`;
                    try {
                        const errorData = await res.json();
                        if (errorData.error) errorMessage = errorData.error;
                    } catch (e) { }
                    throw new Error(errorMessage);
                }

                const result = await res.json();
                const returnedRunId = result.run_id || clientRunId;
                activeRunId = returnedRunId;

                status.innerHTML = `<p style="color: var(--success);">âœ… ã‚­ãƒ¥ãƒ¼è¿½åŠ æˆåŠŸ: run_id=${returnedRunId}</p>`;
                showToast('GitHub ActionsãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ', 'success');

                // Show progress bar and start polling
                progressContainer.style.display = 'block';
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('progress-percent').textContent = '0%';
                document.getElementById('progress-stage').textContent = 'queued';
                document.getElementById('progress-message').textContent = 'Waiting for GitHub Actions to start...';
                document.getElementById('progress-counters').textContent = '';

                // Start polling status
                if (statusPollInterval) clearInterval(statusPollInterval);
                statusPollInterval = setInterval(pollRunStatus, 2000); // Poll every 2 seconds

                // Reset Turnstile
                turnstileToken = null;
                btn.disabled = true;
                if (window.turnstile) window.turnstile.reset();

            } catch (e) {
                status.innerHTML = `<p style="color: var(--danger);">âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`;
                showToast('å®Ÿè¡Œã‚¨ãƒ©ãƒ¼', 'danger');
                btn.disabled = false;
                activeRunId = null;
            }
        }

        // === Poll Runs Update ===
        function pollRunsUpdate(maxAttempts, interval) {
            let attempts = 0;
            const poll = setInterval(() => {
                attempts++;
                loadRuns();
                if (attempts >= maxAttempts) {
                    clearInterval(poll);
                }
            }, interval);
        }

        // === Search Corpus ===
        async function searchCorpus() {
            const query = document.getElementById('search-input').value;
            if (!query) { showToast('æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›', 'warning'); return; }

            const container = document.getElementById('search-results');
            container.innerHTML = '<div class="spinner"></div>';

            try {
                const res = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(query)}&top_k=20`);
                const data = await res.json();

                if (!data.results || data.results.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary);">çµæœãŒã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }

                container.innerHTML = data.results.map(r => `
                    <div class="search-result">
                        <div class="search-result-title">${r.paper_title || 'Unknown Paper'}</div>
                        <div class="search-result-meta">
                            ğŸ“ ${r.locator?.section || 'Unknown'} | Score: ${r.score?.toFixed(2) || 0}
                        </div>
                        <div class="search-result-snippet">${highlightText(r.text?.substring(0, 300) || '', query)}...</div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p style="color: var(--danger);">æ¤œç´¢ã‚¨ãƒ©ãƒ¼</p>';
            }
        }

        function highlightText(text, query) {
            const words = query.toLowerCase().split(/\s+/);
            let result = text;
            words.forEach(w => {
                if (w.length > 2) {
                    const regex = new RegExp(`(${w})`, 'gi');
                    result = result.replace(regex, '<span class="highlight">$1</span>');
                }
            });
            return result;
        }

        // === Collect Papers ===
        async function collectPapers() {
            const query = document.getElementById('collect-query').value;
            if (!query) { showToast('æ¤œç´¢ã‚¯ã‚¨ãƒªã‚’å…¥åŠ›', 'warning'); return; }

            const status = document.getElementById('collect-status');
            status.innerHTML = '<div class="spinner"></div><p>åé›†ä¸­...</p>';

            try {
                const res = await fetch(`${API_BASE}/api/collect/pubmed`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query,
                        max_results: parseInt(document.getElementById('collect-max').value),
                        oa_only: document.getElementById('collect-oa').checked
                    })
                });

                const result = await res.json();
                status.innerHTML = `<p style="color: var(--success);">âœ… ${result.collected || 0}ä»¶åé›†å®Œäº†</p>`;
                showToast('åé›†å®Œäº†', 'success');
            } catch (e) {
                status.innerHTML = `<p style="color: var(--danger);">âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`;
            }
        }

        // === Upload ===
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');

        uploadZone.onclick = () => fileInput.click();
        uploadZone.ondragover = e => { e.preventDefault(); uploadZone.classList.add('dragover'); };
        uploadZone.ondragleave = () => uploadZone.classList.remove('dragover');
        uploadZone.ondrop = async e => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            await handleUpload(e.dataTransfer.files);
        };
        fileInput.onchange = async e => await handleUpload(e.target.files);

        async function handleUpload(files) {
            if (files.length === 0) return;

            const status = document.getElementById('upload-status');
            status.innerHTML = '<div class="spinner"></div><p>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</p>';

            const formData = new FormData();
            for (const file of files) formData.append('files', file);

            try {
                let endpoint = '/api/upload/pdf';
                if (files[0].name.endsWith('.bib')) endpoint = '/api/upload/bibtex';
                else if (files[0].name.endsWith('.zip')) endpoint = '/api/upload/zip';

                const res = await fetch(`${API_BASE}${endpoint}`, { method: 'POST', body: formData });
                const result = await res.json();

                status.innerHTML = `<p style="color: var(--success);">âœ… Accepted: ${result.accepted}, Duplicates: ${result.duplicates}, Rejected: ${result.rejected}</p>`;
                showToast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†', 'success');
            } catch (e) {
                status.innerHTML = `<p style="color: var(--danger);">âŒ ${e.message}</p>`;
            }
        }

        // === Run Detail Modal ===
        async function showRunDetail(runId) {
            const modal = document.getElementById('run-modal');
            const body = document.getElementById('modal-body');
            body.innerHTML = '<div class="spinner"></div>';
            modal.style.display = 'block';

            try {
                const res = await fetch(`${API_BASE}/api/runs/${runId}`);
                const run = await res.json();

                body.innerHTML = `
                    <h2>Run: ${runId}</h2>
                    <table class="data-table" style="margin: 20px 0;">
                        <tr><th>Status</th><td><span class="badge ${run.status === 'success' ? 'badge-success' : 'badge-danger'}">${run.status}</span></td></tr>
                        <tr><th>Gate Passed</th><td>${run.gate_passed ? 'âœ…' : 'âŒ'}</td></tr>
                        <tr><th>Contract Valid</th><td>${run.contract_valid ? 'âœ… 10/10' : 'âŒ Missing files'}</td></tr>
                        <tr><th>Timestamp</th><td>${run.timestamp || '-'}</td></tr>
                    </table>
                    
                    <h3>ğŸ“Š Metrics</h3>
                    <table class="data-table" style="margin: 20px 0;">
                        ${Object.entries(run.metrics || {}).map(([k, v]) =>
                    `<tr><th>${k}</th><td>${typeof v === 'number' ? v.toFixed(4) : v}</td></tr>`
                ).join('')}
                    </table>

                    <h3>ğŸ“ Files</h3>
                    <table class="data-table" style="margin: 20px 0;">
                        ${Object.entries(run.files || {}).map(([name, info]) =>
                    `<tr><td>${info.exists ? 'âœ…' : 'âŒ'} ${name}</td><td>${info.size} bytes</td></tr>`
                ).join('')}
                    </table>

                    ${run.report ? `<h3>ğŸ“ Report</h3><pre style="max-height: 300px; overflow: auto; background: var(--bg-primary); padding: 15px; border-radius: 8px; white-space: pre-wrap;">${escapeHtml(run.report)}</pre>` : ''}
                `;
            } catch (e) {
                body.innerHTML = `<p style="color: var(--danger);">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`;
            }
        }

        function closeModal() { document.getElementById('run-modal').style.display = 'none'; }
        window.onclick = e => { if (e.target === document.getElementById('run-modal')) closeModal(); };

        // === Utilities ===
        function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeftColor = type === 'success' ? 'var(--success)' : type === 'danger' ? 'var(--danger)' : 'var(--warning)';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function refreshAll() {
            loadRuns();
            showToast('æ›´æ–°ã—ã¾ã—ãŸ');
        }

        // === Initialize ===
        checkLocalServer(); // Check if local server is running
        loadRuns();
    </script>
</body>

</html>