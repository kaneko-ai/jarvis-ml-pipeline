# GitHub Actions - New Paper Alerts
# Checks for new papers daily and creates alerts
name: Paper Alerts

on:
  schedule:
    # Daily at 9:00 JST (0:00 UTC)
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      topics:
        description: 'Topics to check (comma-separated)'
        required: false
        default: 'AI healthcare,machine learning medicine,LLM research'

permissions:
  contents: read
  issues: write

jobs:
  check-papers:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Check for new papers
        id: check
        run: |
          python << 'EOF'
          import requests
          import json
          from datetime import datetime, timedelta
          
          # Topics to monitor
          topics = "${{ github.event.inputs.topics || 'AI healthcare,machine learning medicine' }}".split(',')
          
          new_papers = []
          
          for topic in topics:
              topic = topic.strip()
              # Search PubMed for papers from last 24 hours
              yesterday = (datetime.now() - timedelta(days=1)).strftime('%Y/%m/%d')
              today = datetime.now().strftime('%Y/%m/%d')
              
              url = f"https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi"
              params = {
                  'db': 'pubmed',
                  'term': f'{topic}[Title/Abstract]',
                  'datetype': 'pdat',
                  'mindate': yesterday,
                  'maxdate': today,
                  'retmax': 5,
                  'retmode': 'json'
              }
              
              try:
                  resp = requests.get(url, params=params, timeout=30)
                  data = resp.json()
                  count = int(data.get('esearchresult', {}).get('count', 0))
                  
                  if count > 0:
                      ids = data.get('esearchresult', {}).get('idlist', [])
                      new_papers.append({
                          'topic': topic,
                          'count': count,
                          'pmids': ids[:5]
                      })
              except Exception as e:
                  print(f"Error checking {topic}: {e}")
          
          # Save results
          with open('alert_results.json', 'w') as f:
              json.dump(new_papers, f)
          
          # Output for next step
          total = sum(p['count'] for p in new_papers)
          print(f"::set-output name=total::{total}")
          print(f"::set-output name=has_new::{'true' if total > 0 else 'false'}")
          print(f"Found {total} new papers across {len(new_papers)} topics")
          
          EOF

      - name: Create alert issue
        if: steps.check.outputs.has_new == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('alert_results.json', 'utf8'));
            
            let body = `## ðŸ”” New Paper Alert - ${new Date().toLocaleDateString()}\n\n`;
            body += `Found **${results.reduce((s, r) => s + r.count, 0)}** new papers!\n\n`;
            
            for (const result of results) {
              body += `### ${result.topic}\n`;
              body += `**${result.count}** new papers\n\n`;
              for (const pmid of result.pmids) {
                body += `- [PMID: ${pmid}](https://pubmed.ncbi.nlm.nih.gov/${pmid})\n`;
              }
              body += '\n';
            }
            
            body += `---\n*Generated by JARVIS Paper Alerts*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”” New Papers: ${new Date().toLocaleDateString()}`,
              body: body,
              labels: ['paper-alert', 'automated']
            });
