name: Spec Lint

on:
  push:
    branches: [main, master]
    paths:
      - 'docs/**/*.md'
      - 'tools/spec_lint.py'
  pull_request:
    paths:
      - 'docs/**/*.md'
      - 'tools/spec_lint.py'
  workflow_dispatch:

jobs:
  spec-lint:
    runs-on: ubuntu-latest
    name: Spec Authority Lint

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run spec lint
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "Checking PR changes..."
            FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- docs | grep -E '\.md$' || true)
            if [ -n "$FILES" ]; then
              python tools/spec_lint.py --paths $FILES
            else
              echo "No docs modified in this PR. Skipping."
              echo "[PASS] No violations"
            fi
          else
            echo "Full vault check..."
            python tools/spec_lint.py
          fi

      - name: Report
        if: failure()
        run: |
          echo "::error::Spec lint failed. REFERENCE/ROADMAP documents contain forbidden words."
          echo "Run 'python tools/spec_lint.py' locally to see details."
