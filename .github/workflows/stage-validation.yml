# JARVIS CI - Stage Registry & Plugin Validation
# CIで「本当に落ちる」ものにする

name: Stage Registry Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  validate-stages:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]
      
      - name: Import all stages (auto-register)
        run: |
          python << 'EOF'
          # Import stages module to trigger registration
          import jarvis_core.stages
          
          from jarvis_core.pipelines import get_stage_registry
          
          registry = get_stage_registry()
          stages = registry.list_stages()
          
          print(f"Registered stages: {len(stages)}")
          for stage in sorted(stages):
              print(f"  ✓ {stage}")
          
          if len(stages) < 30:
              raise RuntimeError(f"Expected at least 30 stages, got {len(stages)}")
          
          print("\n✅ Stage registration OK")
          EOF
      
      - name: Validate pipeline stages
        run: |
          python << 'EOF'
          import yaml
          from pathlib import Path
          
          # Import stages
          import jarvis_core.stages
          
          from jarvis_core.pipelines import get_stage_registry, StageNotImplementedError
          
          registry = get_stage_registry()
          
          # Load pipeline YAML
          pipeline_path = Path("configs/pipelines/default.yml")
          with open(pipeline_path) as f:
              config = yaml.safe_load(f)
          
          stage_ids = [s["id"] for s in config.get("stages", [])]
          print(f"Pipeline stages: {len(stage_ids)}")
          
          # Validate all stages
          try:
              registry.validate_pipeline(stage_ids)
              print("✅ All pipeline stages are registered!")
          except StageNotImplementedError as e:
              print(f"❌ {e}")
              raise
          EOF

  validate-plugins:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install -e .
      
      - name: Validate plugin.json format
        run: |
          python << 'EOF'
          import json
          from pathlib import Path
          
          REQUIRED_KEYS = {"id", "entrypoint"}
          VALID_TYPES = ["retrieval", "extract", "summarize", "score", "graph", "design", "ops", "ui"]
          
          plugins_dir = Path("plugins")
          errors = []
          
          for plugin_dir in plugins_dir.iterdir():
              if not plugin_dir.is_dir():
                  continue
              
              manifest_path = plugin_dir / "plugin.json"
              
              if not manifest_path.exists():
                  errors.append(f"{plugin_dir.name}: missing plugin.json")
                  continue
              
              try:
                  with open(manifest_path) as f:
                      data = json.load(f)
                  
                  # Check required keys
                  missing = REQUIRED_KEYS - set(data.keys())
                  if missing:
                      errors.append(f"{plugin_dir.name}: missing keys {missing}")
                  
                  # Check type
                  if "type" in data and data["type"] not in VALID_TYPES:
                      errors.append(f"{plugin_dir.name}: invalid type '{data['type']}'")
                  
                  print(f"✓ {plugin_dir.name}: {data.get('id', 'NO_ID')} v{data.get('version', '?')}")
                  
              except json.JSONDecodeError as e:
                  errors.append(f"{plugin_dir.name}: invalid JSON - {e}")
          
          if errors:
              print("\n❌ Plugin validation failed:")
              for e in errors:
                  print(f"  - {e}")
              raise RuntimeError("Plugin validation failed")
          
          print("\n✅ All plugins valid!")
          EOF

  provenance-test:
    runs-on: ubuntu-latest
    needs: [validate-stages, validate-plugins]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install -e .[dev]
      
      - name: Run provenance rate test
        run: |
          python << 'EOF'
          from jarvis_core.contracts import TaskContext, Artifacts, Claim, EvidenceLink
          from jarvis_core.evaluation import get_quality_gates
          
          # Create test claims
          claims = [
              Claim(
                  claim_id="c-1",
                  claim_text="Test claim with evidence",
                  evidence=[EvidenceLink(
                      doc_id="test", section="test", chunk_id="t1",
                      start=0, end=10, confidence=0.9
                  )],
                  claim_type="fact"
              ),
              Claim(
                  claim_id="c-2",
                  claim_text="Another claim with evidence",
                  evidence=[EvidenceLink(
                      doc_id="test", section="test", chunk_id="t2",
                      start=0, end=10, confidence=0.85
                  )],
                  claim_type="fact"
              ),
          ]
          
          gates = get_quality_gates({"provenance_rate": 0.95})
          result = gates.check_provenance(claims)
          
          print(f"Provenance rate: {result.actual:.1%}")
          print(f"Threshold: {result.threshold:.1%}")
          print(f"Passed: {result.passed}")
          
          if not result.passed:
              raise RuntimeError(f"Provenance rate {result.actual:.1%} < {result.threshold:.1%}")
          
          print("✅ Provenance test passed!")
          EOF

  summary:
    runs-on: ubuntu-latest
    needs: [validate-stages, validate-plugins, provenance-test]
    
    steps:
      - name: Summary
        run: |
          echo "## Stage Registry Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Stage Registration | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Pipeline Validation | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Plugin Validation | ✅ |" >> $GITHUB_STEP_SUMMARY
          echo "| Provenance Test | ✅ |" >> $GITHUB_STEP_SUMMARY
