\# JARVIS Research OS — 引き継ぎ書 v3 (HANDOFF)

\# 作成日: 2026-02-28

\# 作成元: Claude Opus 4.6 との対話セッション（3回目）



---



\## 1. プロジェクト概要



\- \*\*リポジトリ\*\*: https://github.com/kaneko-ai/jarvis-ml-pipeline

\- \*\*目的\*\*: 大学院生（PD-1/スペルミジン研究）の論文検索・分析・要約を支援するCLIツール

\- \*\*ユーザー\*\*: 個人利用（kanekiti1125）、プログラミング初学者

\- \*\*期限\*\*: 2026-04-01（研究室配属）までに実用レベルにする

\- \*\*関連リポジトリ\*\*: jarvis-desktop は\*\*凍結中\*\*（CLIに集中する方針）



---



\## 2. 環境情報



| 項目 | 値 |

|---|---|

| OS | Windows 11 |

| CPU | i7-1065G7 (4コア) |

| RAM | 16GB |

| GPU | Intel Iris Plus（GPU推論不可） |

| Python | 3.12.3 |

| PowerShell | \*\*5.1\*\*（7ではない。エスケープやワイルドカードの挙動に注意） |

| venv | C:\\Users\\kaneko yu\\Documents\\jarvis-work\\jarvis-ml-pipeline\\venv |

| Git | 2.39.0.windows.2 |

| LLM API | Gemini API (無料枠、google-genai 1.65.0) |

| LLM model | gemini-2.0-flash |

| GEMINI\_API\_KEY | 環境変数に設定済み |

| ChatGPT Plus | 利用中 |



\### venv 起動手順

```powershell

cd "C:\\Users\\kaneko yu\\Documents\\jarvis-work\\jarvis-ml-pipeline"

\& ".\\venv\\Scripts\\Activate.ps1"

3\. 現在のGitHub状態（main ブランチ）

最新コミット: b8701257 (2026-02-28)



b8701257 feat: add BibTeX export, improve report.md (P1-2, P1-3)

998453f2 feat: add jarvis search command (P1-1)

14938adf feat: improve report.md with paper details (P1-2)  ← assembler.py修正

787477a4 fix: add summary cache, 429 retry, relax QA gate for paper\_survey (BUG-2,3)

1fb51719 fix: improve query extraction, add citations and LLM summaries (BUG-1,2,3)

65765431 fix: add run\_qa\_gate stub, .gitignore venv, add ROADMAP.md

a2b84685 fix: implement actual PubMed search in PaperFetcherAgent

a76b2b60 docs: add repo-level copilot instructions for One True Path gates

ローカルとリモートは同期済み。



4\. 完了済みフェーズ

Phase 0: 環境構築 ✅

Phase 0.5: バグ修正 ✅（BUG-1,2,3解決）

Phase 1: 実用化 ✅（P1-1, P1-2, P1-3 完了）

P1-1: jarvis search コマンド ✅



軽量な論文検索コマンド（run より高速）

PaperFetcherAgent を直接呼び出し

--no-summary でAPI不使用の高速検索

--json でJSON出力対応

logs/search/ にMarkdownレポート自動保存

P1-2: report.md 改善 ✅



run コマンドの report.md に論文詳細を追加

著者、要約、リンク、References セクション

P1-3: BibTeX出力 ✅



--bibtex オプションで .bib ファイル自動生成

Zotero にインポート可能なフォーマット

5\. 動作確認済みコマンド

Copy# 軽量検索（API不使用、高速）

python -m jarvis\_cli search "PD-1" --max 3 --no-summary



\# 日本語要約付き検索（Gemini API使用）

python -m jarvis\_cli search "PD-1" --max 3



\# BibTeX付き検索

python -m jarvis\_cli search "PD-1" --max 3 --no-summary --bibtex



\# JSON出力

python -m jarvis\_cli search "PD-1" --max 3 --no-summary --json



\# フルパイプライン（重い、10ファイル生成）

python -m jarvis\_cli run --goal "Search 3 recent papers about PD-1" --category paper\_survey



\# importテスト

python -c "import jarvis\_cli; print('OK')"

python -c "from jarvis\_cli.bibtex import papers\_to\_bibtex; print('OK')"

python -c "from jarvis\_core.bundle.assembler import BundleAssembler; print('OK')"

6\. コードベース構造（Phase 1 完了後）

jarvis-ml-pipeline/

├── jarvis\_cli/                    ← Phase 1 で新規作成

│   ├── \_\_init\_\_.py               # CLI entry point (run / search)

│   ├── \_\_main\_\_.py               # python -m jarvis\_cli 対応

│   ├── search.py                 # jarvis search コマンド本体

│   └── bibtex.py                 # BibTeX生成モジュール

├── jarvis\_core/

│   ├── app.py                    # run\_task() — フルパイプライン

│   ├── agents.py                 # PaperFetcherAgent（BUG-1,2,3修正済み）

│   ├── bundle/

│   │   └── assembler.py          # BundleAssembler（P1-2でreport改善済み）

│   ├── sources/

│   │   ├── pubmed\_client.py      # PubMedClient（動作確認済み）

│   │   ├── arxiv\_client.py       # ArxivClient

│   │   └── crossref\_client.py    # CrossrefClient

│   └── ...（その他多数、未変更）

├── logs/

│   ├── search/                   # search コマンドの出力先

│   └── runs/                     # run コマンドの出力先

└── pyproject.toml

7\. 次のターゲット: Phase 3（研究準備）

P3-1: PD-1論文100件収集

P3-2: スペルミジン論文50件収集

P3-3: 研究ノート自動生成

推奨戦略:



Gemini API 無料枠 = 1日1500リクエスト

search コマンドは1論文1回のAPI呼び出し（run コマンドの3倍効率的）

20件ずつ、キーワードを変えて5日間で100件収集

Phase 3 の最初のタスクとして「マージ＆重複除去」機能の追加を推奨

Phase 3 で必要な新機能:



マージ機能: 複数の検索結果JSONを統合して重複除去

研究ノート生成: 収集した論文群から研究テーマ別のサマリーを生成

大量検索のレート制限対策: 20件以上を安全に処理する仕組み

8\. 既知の残課題

課題	優先度	説明

BUG-4: run\_qa\_gate がスタブ	低	jarvis\_core/style/init.py。常に pass を返す

EvidenceStore 未登録	低	ExecutionEngine が Citation を弾く。app.py で回避済み

Gemini 429 エラー	中	大量検索時に発生。40秒リトライ + キャッシュで軽減済み

PowerShell 5.1 の type ワイルドカード	情報	type logs\\search\\\*.bib が効かない。ファイル名を直接指定する

9\. Gemini API 制限の詳細

項目	値

Tier	1（無料枠）

RPM	15 リクエスト/分

RPD	1500 リクエスト/日

日次リセット	太平洋時間 0:00（日本時間 17:00）

1論文あたりの待機	4秒（agents.py で実装済み）

429 リトライ	40秒待機して1回リトライ（agents.py で実装済み）

キャッシュ	\_summary\_cache でセッション内の重複防止（agents.py）

計算例:



20件検索 × 1 API呼び出し/件 = 20リクエスト（search コマンド）

20件検索 × 3 API呼び出し/件 = 60リクエスト（run コマンド）

1日の上限 1500 / 20 = 1日最大75件（search コマンド）

10\. PowerShell 5.1 + Python ファイル編集ルール（最重要）

❌ 絶対にやってはいけないこと

PowerShell の python -c "..." で複雑なコードを実行しない



\\", \\n, \\\\, $ を PowerShell が独自に解釈して壊す

1-2行の簡単な確認コマンドだけ OK

PowerShell の > リダイレクトでファイルを書かない



git show HASH:path > file は UTF-16 で書き出す → Python がエラー

代わりに git checkout HASH -- path を使う

Python ファイルを UTF-8 BOM で保存しない



encoding='utf-8-sig' は使わない

メモ帳のデフォルト保存は BOM なし UTF-8 なので通常は問題ない

パッチスクリプトで文字列の完全一致を前提にしない



今回のセッションで \_build\_report の文字列置換が失敗した

行番号ベースの置換の方が確実

PowerShell 5.1 で type \*.bib のようなワイルドカードを使わない



ファイル名を直接指定する（例: type "logs\\search\\PD-1\_20260228\_031200.bib"）

✅ 正しいやり方

ファイル作成・編集は notepad ファイル名 で行う



AIがコードブロックを出力 → ユーザーがメモ帳にコピペ → Ctrl+S → 保存

これが最も安全で確実

新規ファイルの場合: notepad 新しいファイル.py → 「新しく作成しますか？」→ はい



既存ファイルの修正の場合: notepad 既存ファイル.py → メモ帳で開く → Ctrl+A で全選択 → 新しい内容を貼り付け → Ctrl+S



パッチスクリプトを使う場合: 行番号ベースで置換する



Copy# まず行番号を確認

python -c "f=open('ファイル.py','r',encoding='utf-8');lines=f.readlines();starts=\[i for i,l in enumerate(lines) if 'def メソッド名' in l];print(starts)"

\# → \[487] のように行番号が表示される

\# その行番号を使って置換スクリプトを書く

簡単な確認コマンド（1-2行）だけ python -c "..." でOK



例: python -c "import jarvis\_cli; print('OK')"

ただし \\", \\n, $ を含むコードは避ける

11\. 今回のセッション（3回目）で起きた問題と解決

問題1: jarvis\_cli ディレクトリが存在しなかった

状況: 引き継ぎ書 v2 に jarvis\_cli が記載されていたが、GitHubにもローカルにも存在しなかった

原因: pyproject.toml に jarvis = "jarvis\_cli:main" と定義されていたが、実際のファイルは未作成だった

解決: mkdir jarvis\_cli でディレクトリ作成、3ファイルを新規作成

問題2: パッチスクリプトの文字列完全一致が失敗

状況: patch\_report.py で \_build\_report メソッドの文字列置換を試みたが old\_method not found

原因: Unicode エスケープ（\\u2705, \\u274c, \\u26a0）やインデント、改行の微妙な違い

解決: 行番号ベースの置換（patch\_report2.py）で成功

教訓: 長いメソッドの文字列完全一致は避ける。行番号を先に確認してから置換する

問題3: パッチの部分適用

状況: patch\_bibtex.py で search.py への bibtex 保存コードの挿入が「already exists」と誤判定

原因: import文だけ追加されて保存コードが追加されなかったが、パッチが「bibtex」という文字列の存在を検出して「already exists」と判断

解決: search.py を まるごと書き直し（メモ帳で Ctrl+A → 全貼り替え）

教訓: パッチが部分的に適用された場合、ファイル全体を書き直す方が安全

問題4: PowerShell 5.1 の type コマンドでワイルドカードが効かない

状況: type logs\\search\\PD-1\_\*.bib がエラー

原因: PowerShell 5.1 の Get-Content はワイルドカードの扱いが制限的

解決: ファイル名を直接指定（dir で確認してからコピペ）

12\. ユーザーへの対応方針

プログラミング初学者なので、変更の理由と影響を丁寧に説明する

コピペだけで進められる粒度で指示を出す

1ステップ = 1コマンド。まとめて実行させない（PowerShell 5.1 の問題回避）

notepad でファイルを作る手順を省略しない

「新しく作成しますか？」→「はい」の確認も明記する

エラーが出ても「大丈夫、一緒に直します」のスタンス

コマンドは 1行ずつ 貼り付けてもらう（ただしユーザーが慣れてきたらまとめてOK）

13\. パイプライン実行フロー

search コマンド（軽量・推奨）

python -m jarvis\_cli search "PD-1" --max 5 --bibtex

&nbsp; ↓

jarvis\_cli/\_\_init\_\_.py: main() → \_cmd\_search()

&nbsp; ↓

jarvis\_cli/search.py: run\_search()

&nbsp; ├── PaperFetcherAgent.\_search\_papers() → PubMed → arXiv → Crossref

&nbsp; ├── PaperFetcherAgent.\_enrich\_papers\_with\_llm() → Gemini API

&nbsp; ├── \_print\_papers() → ターミナル表示

&nbsp; ├── \_build\_report\_md() → logs/search/<query>\_<date>.md

&nbsp; └── save\_bibtex() → logs/search/<query>\_<date>.bib

run コマンド（フルパイプライン・重い）

python -m jarvis\_cli run --goal "..." --category paper\_survey

&nbsp; ↓

jarvis\_cli/\_\_init\_\_.py: main() → \_cmd\_run()

&nbsp; ↓

jarvis\_core/app.py: run\_task()

&nbsp; ├── Planner.plan() → 3サブタスク

&nbsp; ├── ExecutionEngine.run() → Router → PaperFetcherAgent（3回）

&nbsp; ├── QualityGateVerifier.verify()

&nbsp; └── BundleAssembler.build() → logs/runs/<id>/ に10ファイル

14\. 検証コマンド集

Copy# 環境確認

python --version

pip show google-genai



\# import テスト

python -c "import jarvis\_cli; print('OK')"

python -c "from jarvis\_cli.bibtex import papers\_to\_bibtex; print('OK')"

python -c "from jarvis\_core.agents import PaperFetcherAgent; print('OK')"



\# 軽量検索テスト（API不使用）

python -m jarvis\_cli search "PD-1" --max 3 --no-summary



\# 日本語要約テスト（API使用）

python -m jarvis\_cli search "PD-1" --max 3



\# BibTeX テスト（API不使用）

python -m jarvis\_cli search "PD-1" --max 3 --no-summary --bibtex



\# フルパイプラインテスト（API使用・重い）

python -m jarvis\_cli run --goal "Search 3 recent papers about PD-1" --category paper\_survey

15\. ロードマップ（残タスク）

Phase 0: 環境構築 ✅

Phase 0.5: バグ修正 ✅

Phase 1: 実用化 ✅

Phase 3: 研究準備 ← 次のターゲット

P3-0: マージ＆重複除去機能（新規追加推奨）

P3-1: PD-1論文100件収集

P3-2: スペルミジン論文50件収集

P3-3: 研究ノート自動生成

Phase 2: 高度機能（後回し）

P2-1: Codex CLI プロバイダー統合

P2-2: Citation analysis

P2-3: PRISMA図

Phase 4: UI（4月以降）

P4-1: Streamlit ダッシュボード

16\. 成功の定義（2026-04-01）

Copypython -m jarvis\_cli search "PD-1 immunotherapy" --max 20 --bibtex

\# 期待: PD-1関連論文20件 + 日本語要約 + BibTeX



python -m jarvis\_cli search "spermidine autophagy" --max 10 --bibtex

\# 期待: スペルミジン関連論文10件 + 日本語要約 + BibTeX



\# logs/search/ に蓄積された全論文をマージ → 重複除去 → 研究ノート生成

