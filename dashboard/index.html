<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Research OS Dashboard - Home</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>

<body data-page="index">
  <nav class="top-nav" data-testid="top-nav">
    <a href="index.html" data-testid="nav-home">Home</a>
    <a href="runs.html" data-testid="nav-runs">Runs</a>
    <a href="ops.html" data-testid="nav-ops">Ops</a>
    <a href="schedule.html" data-testid="nav-schedule">Schedule</a>
    <a href="kb.html" data-testid="nav-kb">KB</a>
    <a href="search.html" data-testid="nav-search">Search</a>
    <a href="settings.html" data-testid="nav-settings">Settings</a>
  </nav>
  <main class="container">
    <header class="page-header">
      <h1 data-testid="page-title">Research OS Dashboard</h1>
      <p>ヘルス、KPI、最新のRunを確認します。</p>
    </header>

    <section class="panel">
      <div class="section-title">
        <h2>Run Pipeline</h2>
      </div>
      <div class="form-group">
        <input type="text" id="run-query" placeholder="Enter search query (e.g. CD73 immunotherapy)"
          class="input-full" />
        <button id="run-button" class="primary">Run Dispatch</button>
      </div>
      <div id="run-status-area" class="notice" style="display:none;">
        <p>Run ID: <span id="current-run-id">-</span></p>
        <div id="progress-bar-container" style="background:#eee; height:10px; border-radius:5px; margin: 10px 0;">
          <div id="progress-bar"
            style="background:var(--primary); height:100%; width:0%; border-radius:5px; transition: width 0.3s;"></div>
        </div>
        <p id="progress-message">Waiting...</p>
      </div>
    </section>

    <section class="panel">
      <div class="section-title">
        <h2>Latest Runs</h2>
        <a class="badge" href="runs.html" data-testid="latest-runs-link">一覧へ</a>
      </div>
      <table class="table" id="latest-runs" data-testid="latest-runs-table">
        <thead>
          <tr>
            <th>Run ID</th>
            <th>Action</th>
            <th>Query</th>
            <th>Status</th>
            <th>Finished</th>
            <th>Artifacts</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="latest-runs-empty" class="notice" data-testid="latest-runs-empty">データがありません。</div>
    </section>
  </main>

  <script src="assets/storage.js"></script>
  <script src="assets/app.js"></script>
  <script src="assets/ui.js"></script>
  <script src="components/run_list.js"></script>
  <script>
    const init = async () => {
      const renderLatestRuns = async () => {
        const empty = ui.qs("#latest-runs-empty");
        const res = await app.apiFetchSafe("/api/runs");

        if (!res.ok || !res.data) {
          empty.textContent = "未接続またはデータがありません";
          empty.style.display = "block";
          return;
        }

        empty.style.display = Object.keys(res.data).length > 0 ? "none" : "block";
        runList.render("latest-runs", res.data);
      };

      const pollProgress = async (runId) => {
        const progressBar = ui.qs("#progress-bar");
        const progressMessage = ui.qs("#progress-message");
        const apiBase = app.getApiBase().replace("/api", "");

        const interval = setInterval(async () => {
          try {
            // Attempt to fetch progress.json directly (acting as proxy if needed via worker or gh-pages)
            // But for now, we assume dashboard/runs/<id>/progress.json
            const resp = await fetch(`${apiBase}/runs/${runId}/progress.json`, { cache: 'no-store' });
            if (!resp.ok) return;

            const progress = await resp.json();
            progressBar.style.width = `${progress.percent}%`;
            progressMessage.textContent = `[${progress.phase}] ${progress.message}`;

            if (progress.phase === "done" || progress.phase === "failed") {
              clearInterval(interval);
              ui.qs("#run-button").disabled = false;
              renderLatestRuns();
              if (progress.phase === "failed") {
                ui.toast("Run失敗: " + progress.message, "danger");
              } else {
                ui.toast("Run完了!", "success");
              }
            }
          } catch (e) {
            console.warn("Polling error:", e);
          }
        }, 5000);
      };

      const runButton = ui.qs("#run-button");
      runButton.addEventListener("click", async () => {
        const query = ui.qs("#run-query").value.trim();
        if (!query) return ui.toast("Queryを入力してください", "warning");

        runButton.disabled = true;
        ui.qs("#run-status-area").style.display = "block";
        ui.qs("#progress-message").textContent = "Triggering GitHub Actions...";

        const res = await app.apiFetchSafe("/api/run", {
          method: "POST",
          body: { action: "report", query: query, max_papers: 10, turnstile_token: "local-dev" }
        });

        if (!res.ok) {
          ui.toast(`失敗: ${res.error}`, "danger");
          runButton.disabled = false;
          return;
        }

        const runId = res.data.run_id;
        ui.qs("#current-run-id").textContent = runId;
        ui.toast(`Run開始: ${runId}`, "success");
        pollProgress(runId);
      });

      renderLatestRuns();
    };
    init();
  </script>
</body>

</html>
</body>

</html>