<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Research OS Dashboard - Home</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body data-page="index">
  <nav class="top-nav">
    <a href="index.html">Home</a>
    <a href="runs.html">Runs</a>
    <a href="schedule.html">Schedule</a>
    <a href="feedback.html">Feedback Risk</a>
    <a href="decision.html">Decision</a>
    <a href="finance.html">Finance</a>
    <a href="settings.html">Settings</a>
  </nav>
  <main class="container">
    <header class="page-header">
      <h1>Research OS Dashboard</h1>
      <p>ヘルス、KPI、最新のRunを確認します。</p>
    </header>

    <section class="panel">
      <div class="section-title">
        <h2>Health</h2>
        <button class="secondary" id="refresh-health">更新</button>
      </div>
      <div class="grid cols-2">
        <div>
          <p class="muted">/api/health</p>
          <div id="health-status" class="notice">未接続</div>
          <div id="health-warnings"></div>
        </div>
        <div>
          <p class="muted">/api/health/cron</p>
          <div id="cron-status" class="notice">未接続</div>
          <div id="cron-jobs"></div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="section-title">
        <h2>KPI</h2>
        <button class="secondary" id="refresh-kpi">更新</button>
      </div>
      <div class="grid cols-4" id="kpi-grid"></div>
    </section>

    <section class="panel">
      <div class="section-title">
        <h2>Runs</h2>
        <a class="badge" href="runs.html">runs.htmlへ</a>
      </div>
      <div class="notice">Runs一覧は runs.html で確認してください。</div>
    </section>
  </main>

  <script src="assets/app.js"></script>
  <script src="assets/ui.js"></script>
  <script>
    const setActiveNav = () => {
      const page = document.body.dataset.page;
      ui.qsa(".top-nav a").forEach((link) => {
        if (link.getAttribute("href").includes(page)) {
          link.classList.add("active");
        }
      });
    };

    const renderHealth = async () => {
      const healthEl = ui.qs("#health-status");
      const cronEl = ui.qs("#cron-status");
      const warningEl = ui.qs("#health-warnings");
      const cronJobsEl = ui.qs("#cron-jobs");
      warningEl.innerHTML = "";
      cronJobsEl.innerHTML = "";

      const health = await app.apiFetchSafe("/api/health");
      if (health.ok) {
        const data = health.data || {};
        healthEl.innerHTML = "";
        healthEl.appendChild(ui.badge(data.redis_ok ? "Redis OK" : "Redis NG", data.redis_ok ? "success" : "danger"));
        healthEl.appendChild(ui.badge(data.worker_heartbeat_ok ? "Worker OK" : "Worker NG", data.worker_heartbeat_ok ? "success" : "danger"));
        if (Array.isArray(data.warnings) && data.warnings.length) {
          warningEl.appendChild(ui.el("div", { className: "notice", text: data.warnings.join(" / ") }));
        }
      } else {
        healthEl.textContent = "未実装/未接続";
      }

      const cron = await app.apiFetchSafe("/api/health/cron");
      if (cron.ok) {
        const data = cron.data || {};
        cronEl.innerHTML = "";
        cronEl.appendChild(ui.badge(data.redis_ok ? "Redis OK" : "Redis NG", data.redis_ok ? "success" : "danger"));
        cronEl.appendChild(ui.badge(data.worker_heartbeat_ok ? "Cron OK" : "Cron NG", data.worker_heartbeat_ok ? "success" : "danger"));
        if (Array.isArray(data.last_cron_jobs)) {
          data.last_cron_jobs.slice(0, 4).forEach((job) => {
            cronJobsEl.appendChild(ui.el("div", { className: "muted", text: JSON.stringify(job) }));
          });
        }
      } else {
        cronEl.textContent = "未実装/未接続";
      }
    };

    const renderKpi = async () => {
      const grid = ui.qs("#kpi-grid");
      grid.innerHTML = "";
      const runs = await app.apiFetchSafe("/api/runs");
      if (!runs.ok) {
        grid.appendChild(ui.el("div", { className: "notice", text: "未接続" }));
        return;
      }
      const list = runs.data || [];
      const total = list.length;
      const running = list.filter((item) => item.status === "running").length;
      const success = list.filter((item) => item.status === "success").length;
      const qaReady = list.filter((item) => item.qa_status === "READY").length;

      const cards = [
        { label: "Total Runs", value: total },
        { label: "Running", value: running },
        { label: "Success", value: success },
        { label: "QA Ready", value: qaReady },
      ];
      cards.forEach((card) => {
        const node = ui.el("div", { className: "kpi-card" });
        node.appendChild(ui.el("h3", { text: card.label }));
        node.appendChild(ui.el("div", { className: "value", text: ui.formatNumber(card.value) }));
        grid.appendChild(node);
      });
    };

    const init = () => {
      setActiveNav();
      renderHealth();
      renderKpi();
      ui.qs("#refresh-health").addEventListener("click", renderHealth);
      ui.qs("#refresh-kpi").addEventListener("click", renderKpi);
    };

    init();
  </script>
</body>
</html>
