<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Research OS Dashboard - Home</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>

<body data-page="index">
  <nav class="top-nav" data-testid="top-nav">
    <a href="index.html" data-testid="nav-home">Home</a>
    <a href="runs.html" data-testid="nav-runs">Runs</a>
    <a href="ops.html" data-testid="nav-ops">Ops</a>
    <a href="schedule.html" data-testid="nav-schedule">Schedule</a>
    <a href="kb.html" data-testid="nav-kb">KB</a>
    <a href="search.html" data-testid="nav-search">Search</a>
    <a href="settings.html" data-testid="nav-settings">Settings</a>
  </nav>
  <main class="container">
    <header class="page-header">
      <h1 data-testid="page-title">Research OS Dashboard</h1>
      <p>ヘルス、KPI、最新のRunを確認します。</p>
    </header>

    <section class="panel">
      <div class="section-title">
        <h2>Run Pipeline</h2>
      </div>
      <div class="form-group">
        <input type="text" id="run-query" placeholder="Enter search query (e.g. CD73 immunotherapy)"
          class="input-full" />
        <button id="run-button" class="primary">Run Dispatch</button>
      </div>
      <div id="run-status-area" class="notice" style="display:none;">
        <p>Run ID: <span id="current-run-id">-</span></p>
        <div id="progress-bar-container" style="background:#eee; height:10px; border-radius:5px; margin: 10px 0;">
          <div id="progress-bar"
            style="background:var(--primary); height:100%; width:0%; border-radius:5px; transition: width 0.3s;"></div>
        </div>
        <p id="progress-message">Waiting...</p>
      </div>
    </section>

    <section class="panel">
      <div class="section-title">
        <h2>Latest Runs</h2>
        <a class="badge" href="runs.html" data-testid="latest-runs-link">一覧へ</a>
      </div>
      <table class="table" id="latest-runs" data-testid="latest-runs-table">
        <thead>
          <tr>
            <th>Run ID</th>
            <th>Action</th>
            <th>Query</th>
            <th>Status</th>
            <th>Finished</th>
            <th>Artifacts</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="latest-runs-empty" class="notice" data-testid="latest-runs-empty">データがありません。</div>
    </section>
  </main>

  <script src="assets/storage.js"></script>
  <script src="assets/app.js"></script>
  <script src="assets/ui.js"></script>
  <script>
    const init = async () => {
      // Latest Runs rendering
      const renderLatestRuns = async () => {
        const tableBody = ui.qs("#latest-runs tbody");
        const empty = ui.qs("#latest-runs-empty");
        tableBody.innerHTML = "";

        // Use /api/runs (proxied to gh-pages index.json)
        const res = await app.apiFetchSafe("/api/runs");
        if (!res.ok) {
          empty.textContent = "未接続またはデータがありません";
          empty.style.display = "block";
          return;
        }

        const list = (res.data || []).slice(0, 5);
        if (!list.length) {
          empty.style.display = "block";
          return;
        }
        empty.style.display = "none";

        list.forEach((run) => {
          const row = ui.el("tr");
          row.appendChild(ui.el("td", { text: run.run_id }));
          row.appendChild(ui.el("td", { text: run.action || "-" }));
          row.appendChild(ui.el("td", { text: run.inputs?.query || "-" }));
          row.appendChild(ui.el("td", {
            html: ui.badge(run.status, run.status === "succeeded" ? "success" : "danger").outerHTML
          }));
          row.appendChild(ui.el("td", { text: ui.formatDateTime(run.finished_at) }));

          const links = ui.el("div");
          if (run.outputs?.report_path) {
            const baseUrl = app.getApiBase().replace("/api", "");
            const reportUrl = `${baseUrl}/${run.outputs.report_path}`;
            links.appendChild(ui.el("a", { text: "Report", attrs: { href: reportUrl, target: "_blank" } }));
          }
          row.appendChild(ui.el("td", { html: links.innerHTML }));

          tableBody.appendChild(row);
        });
      };

      // Run Dispatch logic
      const runButton = ui.qs("#run-button");
      const runQuery = ui.qs("#run-query");

      runButton.addEventListener("click", async () => {
        const query = runQuery.value.trim();
        if (!query) {
          ui.toast("Queryを入力してください", "warning");
          return;
        }

        runButton.disabled = true;
        ui.qs("#run-status-area").style.display = "block";
        ui.qs("#progress-message").textContent = "Triggering GitHub Actions...";

        const res = await app.apiFetchSafe("/api/run", {
          method: "POST",
          body: {
            action: "report",
            query: query,
            max_papers: 10,
            turnstile_token: "dummy-or-real-token" // 実際にはTurnstileウィジェットが必要
          }
        });

        if (!res.ok) {
          ui.toast(`失敗: ${res.error.message}`, "danger");
          runButton.disabled = false;
          return;
        }

        const run_id = res.data.run_id;
        ui.qs("#current-run-id").textContent = run_id;
        ui.toast(`Run開始: ${run_id}`, "success");

        // Polling (simplified simulation as we don't have direct progress API in new spec)
        // In real use, we would poll runs/<run_id>/progress.json from gh-pages
        let pollCount = 0;
        const interval = setInterval(async () => {
          pollCount++;
          const progress = Math.min(pollCount * 10, 95);
          ui.qs("#progress-bar").style.width = `${progress}%`;
          ui.qs("#progress-message").textContent = "Running on GitHub Actions (this may take 2-5 mins)...";

          if (pollCount > 30) {
            clearInterval(interval);
            ui.qs("#progress-message").textContent = "Check 'Latest Runs' in a few minutes.";
            runButton.disabled = false;
            renderLatestRuns();
          }
        }, 5000);
      });

      renderLatestRuns();
    };

    init();
  </script>
</body>

</html>
</body>

</html>