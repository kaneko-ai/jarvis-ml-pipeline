<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Research OS Dashboard - Home</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body data-page="index">
    <nav class="top-nav" data-testid="top-nav">
    <a href="index.html" data-testid="nav-home">Home</a>
    <a href="runs.html" data-testid="nav-runs">Runs</a>
    <a href="ops.html" data-testid="nav-ops">Ops</a>
    <a href="schedule.html" data-testid="nav-schedule">Schedule</a>
    <a href="kb.html" data-testid="nav-kb">KB</a>
    <a href="search.html" data-testid="nav-search">Search</a>
    <a href="settings.html" data-testid="nav-settings">Settings</a>
  </nav>
  <main class="container">
    <header class="page-header">
      <h1 data-testid="page-title">Research OS Dashboard</h1>
      <p>ヘルス、KPI、最新のRunを確認します。</p>
    </header>

    <section class="panel">
      <div class="section-title">
        <h2>Health</h2>
        <button class="secondary" id="refresh-health" data-testid="refresh-health">更新</button>
      </div>
      <div class="grid cols-2">
        <div>
          <p class="muted">/api/health</p>
          <div id="health-status" class="notice" data-testid="health-status">未接続</div>
          <div id="health-warnings" data-testid="health-warnings"></div>
        </div>
        <div>
          <p class="muted">/api/health/cron</p>
          <div id="cron-status" class="notice" data-testid="cron-status">未接続</div>
          <div id="cron-jobs" data-testid="cron-jobs"></div>
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="section-title">
        <h2>KPI</h2>
        <button class="secondary" id="refresh-kpi" data-testid="refresh-kpi">更新</button>
      </div>
      <div class="grid cols-4" id="kpi-grid" data-testid="kpi-grid"></div>
    </section>

    <section class="panel">
      <div class="section-title">
        <h2>Latest Runs</h2>
        <a class="badge" href="runs.html" data-testid="latest-runs-link">一覧へ</a>
      </div>
      <table class="table" id="latest-runs" data-testid="latest-runs-table">
        <thead>
          <tr>
            <th>Run ID</th>
            <th>Status</th>
            <th>Progress</th>
            <th>Tier Summary</th>
            <th>QA</th>
            <th>Submission</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="latest-runs-empty" class="notice" data-testid="latest-runs-empty">データがありません。</div>
    </section>
  </main>

  <script src="assets/storage.js"></script>
  <script src="assets/app.js"></script>
  <script src="assets/ui.js"></script>
  <script>
    const setActiveNav = () => {
      const page = document.body.dataset.page;
      ui.qsa(".top-nav a").forEach((link) => {
        if (link.getAttribute("href").includes(page)) {
          link.classList.add("active");
        }
      });
    };

    let runsEnabled = true;

    const renderHealth = async () => {
      const healthEl = ui.qs("#health-status");
      const cronEl = ui.qs("#cron-status");
      const warningEl = ui.qs("#health-warnings");
      const cronJobsEl = ui.qs("#cron-jobs");
      warningEl.innerHTML = "";
      cronJobsEl.innerHTML = "";

      const health = await app.apiFetchSafe(app.getPath("health"));
      if (health.ok) {
        const data = health.data || {};
        healthEl.innerHTML = "";
        healthEl.appendChild(ui.badge(data.redis_ok ? "Redis OK" : "Redis NG", data.redis_ok ? "success" : "danger"));
        healthEl.appendChild(ui.badge(data.worker_heartbeat_ok ? "Worker OK" : "Worker NG", data.worker_heartbeat_ok ? "success" : "danger"));
        if (Array.isArray(data.warnings) && data.warnings.length) {
          warningEl.appendChild(ui.el("div", { className: "notice", text: data.warnings.join(" / ") }));
        }
      } else {
        healthEl.textContent = "未実装/未接続";
      }

      const cron = await app.apiFetchSafe(app.getPath("health_cron"));
      if (cron.ok) {
        const data = cron.data || {};
        cronEl.innerHTML = "";
        cronEl.appendChild(ui.badge(data.redis_ok ? "Redis OK" : "Redis NG", data.redis_ok ? "success" : "danger"));
        cronEl.appendChild(ui.badge(data.worker_heartbeat_ok ? "Cron OK" : "Cron NG", data.worker_heartbeat_ok ? "success" : "danger"));
        if (Array.isArray(data.last_cron_jobs)) {
          data.last_cron_jobs.slice(0, 4).forEach((job) => {
            cronJobsEl.appendChild(ui.el("div", { className: "muted", text: JSON.stringify(job) }));
          });
        }
      } else {
        cronEl.textContent = "未実装/未接続";
      }
    };

    const renderKpi = async () => {
      const grid = ui.qs("#kpi-grid");
      grid.innerHTML = "";
      const runs = await app.apiFetchSafe(app.getPath("runs_list"));
      if (!runs.ok) {
        grid.appendChild(ui.el("div", { className: "notice", text: "未接続" }));
        return;
      }
      const list = runs.data || [];
      const total = list.length;
      const running = list.filter((item) => item.status === "running").length;
      const success = list.filter((item) => item.status === "success").length;
      const qaReady = list.filter((item) => item.qa_status === "READY").length;

      const cards = [
        { label: "Total Runs", value: total },
        { label: "Running", value: running },
        { label: "Success", value: success },
        { label: "QA Ready", value: qaReady },
      ];
      cards.forEach((card) => {
        const node = ui.el("div", { className: "kpi-card" });
        node.appendChild(ui.el("h3", { text: card.label }));
        node.appendChild(ui.el("div", { className: "value", text: ui.formatNumber(card.value) }));
        grid.appendChild(node);
      });
    };

    const renderLatestRuns = async () => {
      const tableBody = ui.qs("#latest-runs tbody");
      const empty = ui.qs("#latest-runs-empty");
      tableBody.innerHTML = "";
      const runs = await app.apiFetchSafe(app.getPath("runs_list"));
      if (!runs.ok) {
        empty.textContent = "未接続";
        empty.style.display = "block";
        return;
      }
      const list = (runs.data || []).slice(0, 5);
      if (!list.length) {
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";
      list.forEach((run) => {
        const row = ui.el("tr");
        const idLink = ui.el("a", { text: run.id || run.run_id || "-", attrs: { href: `run.html?id=${run.id || run.run_id}` } });
        row.appendChild(ui.el("td", { html: idLink.outerHTML }));
        row.appendChild(ui.el("td", { text: run.status || "-" }));
        row.appendChild(ui.el("td", { text: run.progress || run.step || "-" }));
        row.appendChild(ui.el("td", { text: run.tier_summary || "-" }));
        row.appendChild(ui.el("td", { text: run.qa_status || run.qa_ready || "-" }));
        row.appendChild(ui.el("td", { text: run.submission_status || "-" }));
        row.appendChild(ui.el("td", { text: ui.formatDateTime(run.created_at) }));
        tableBody.appendChild(row);
      });
    };

    const applyCapabilities = async () => {
      const result = await app.getCapabilities();
      if (result.ok) {
        ui.applyCapabilitiesToNav(result.data);
        runsEnabled = app.isFeatureEnabled(result.data, "runs");
        if (!runsEnabled) {
          ui.qs("#kpi-grid").innerHTML = "";
          ui.qs("#kpi-grid").appendChild(ui.el("div", { className: "notice", text: "未実装" }));
          ui.qs("#latest-runs tbody").innerHTML = "";
          const empty = ui.qs("#latest-runs-empty");
          empty.textContent = "未実装";
          empty.style.display = "block";
        }
        return;
      }
      runsEnabled = false;
      ui.applyCapabilitiesToNav({});
      ui.qs("#kpi-grid").innerHTML = "";
      ui.qs("#kpi-grid").appendChild(ui.el("div", { className: "notice", text: "未接続" }));
      const empty = ui.qs("#latest-runs-empty");
      empty.textContent = "未接続";
      empty.style.display = "block";
    };

    const init = async () => {
      setActiveNav();
      await applyCapabilities();
      renderHealth();
      if (runsEnabled) {
        renderKpi();
        renderLatestRuns();
      }
      ui.qs("#refresh-health").addEventListener("click", renderHealth);
      ui.qs("#refresh-kpi").addEventListener("click", () => {
        if (runsEnabled) {
          renderKpi();
          renderLatestRuns();
        }
      });
    };

    init();
  </script>
</body>
</html>
