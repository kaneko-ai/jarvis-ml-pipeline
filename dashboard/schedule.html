<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Schedule - Research OS Dashboard</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body data-page="schedule">
    <nav class="top-nav" data-testid="top-nav">
    <a href="index.html" data-testid="nav-home">Home</a>
    <a href="runs.html" data-testid="nav-runs">Runs</a>
    <a href="ops.html" data-testid="nav-ops">Ops</a>
    <a href="schedule.html" data-testid="nav-schedule">Schedule</a>
    <a href="kb.html" data-testid="nav-kb">KB</a>
    <a href="search.html" data-testid="nav-search">Search</a>
    <a href="settings.html" data-testid="nav-settings">Settings</a>
  </nav>
  <main class="container">
    <header class="page-header">
      <h1 data-testid="page-title">Schedule</h1>
      <p>定期実行スケジュールの作成・編集・即時実行。</p>
    </header>

    <section class="panel">
      <div class="section-title">
        <h2>Create Schedule</h2>
      </div>
      <div class="form-grid">
        <label>
          Name
          <input id="schedule-name" placeholder="CD73 OA weekly" data-testid="schedule-name" />
        </label>
        <label>
          Timezone
          <input id="schedule-timezone" placeholder="Asia/Tokyo" value="Asia/Tokyo" data-testid="schedule-timezone" />
        </label>
        <label>
          RRULE preset
          <select id="schedule-rrule-preset" data-testid="schedule-rrule-preset">
            <option value="">Custom</option>
            <option value="DAILY">Daily</option>
            <option value="WEEKLY">Weekly (Mon 03:00)</option>
            <option value="MONTHLY">Monthly (1st 03:00)</option>
          </select>
        </label>
        <label>
          RRULE
          <input id="schedule-rrule" placeholder="FREQ=WEEKLY;BYDAY=MO;BYHOUR=3;BYMINUTE=0;BYSECOND=0" data-testid="schedule-rrule" />
        </label>
        <label>
          Keywords (comma)
          <input id="schedule-keywords" placeholder="CD73,NT5E" data-testid="schedule-keywords" />
        </label>
        <label>
          Date range (days)
          <input id="schedule-date-range" type="number" value="30" data-testid="schedule-date-range" />
        </label>
        <label>
          Max papers
          <input id="schedule-max-papers" type="number" value="50" data-testid="schedule-max-papers" />
        </label>
        <label>
          OA only
          <select id="schedule-oa-only" data-testid="schedule-oa-only">
            <option value="true" selected>Yes</option>
            <option value="false">No</option>
          </select>
        </label>
        <label>
          OA policy
          <select id="schedule-oa-policy" data-testid="schedule-oa-policy">
            <option value="strict" selected>Strict</option>
            <option value="lenient">Lenient</option>
          </select>
        </label>
        <label>
          Max runtime (minutes)
          <input id="schedule-max-runtime" type="number" value="60" data-testid="schedule-max-runtime" />
        </label>
        <label>
          Max retries
          <input id="schedule-max-retries" type="number" value="3" data-testid="schedule-max-retries" />
        </label>
        <label>
          Cooldown (minutes)
          <input id="schedule-cooldown" type="number" value="30" data-testid="schedule-cooldown" />
        </label>
      </div>
      <div class="form-row">
        <label class="checkbox">
          <input id="schedule-output-notes" type="checkbox" checked data-testid="schedule-output-notes" />
          Generate notes
        </label>
        <label class="checkbox">
          <input id="schedule-output-zip" type="checkbox" checked data-testid="schedule-output-zip" />
          Generate package zip
        </label>
        <label class="checkbox">
          <input id="schedule-output-submission" type="checkbox" data-testid="schedule-output-submission" />
          Generate submission package
        </label>
      </div>
      <button id="create-schedule" data-testid="create-schedule">Create</button>
      <div id="schedule-create-status" class="notice" data-testid="schedule-create-status">未実行</div>
    </section>

    <section class="panel">
      <div class="section-title">
        <h2>Schedules</h2>
        <button class="secondary" id="refresh-schedule" data-testid="refresh-schedule">更新</button>
      </div>
      <table class="table" id="schedule-table" data-testid="schedule-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Enabled</th>
            <th>Next Run</th>
            <th>Last Run</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="schedule-empty" class="notice" data-testid="schedule-empty">未接続</div>
    </section>

    <section class="panel">
      <div class="section-title">
        <h2>History</h2>
        <span id="history-title" class="muted" data-testid="history-title">未選択</span>
      </div>
      <table class="table" id="history-table" data-testid="history-table">
        <thead>
          <tr>
            <th>Run ID</th>
            <th>Status</th>
            <th>Attempts</th>
            <th>Error</th>
            <th>Updated</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="history-empty" class="notice" data-testid="history-empty">履歴がありません</div>
    </section>
  </main>

  <script src="assets/storage.js"></script>
  <script src="assets/app.js"></script>
  <script src="assets/ui.js"></script>
  <script>
    const setActiveNav = () => {
      const page = document.body.dataset.page;
      ui.qsa(".top-nav a").forEach((link) => {
        if (link.getAttribute("href").includes(page)) {
          link.classList.add("active");
        }
      });
    };

    const presetToRrule = (preset) => {
      if (preset === "DAILY") {
        return "FREQ=DAILY;BYHOUR=3;BYMINUTE=0;BYSECOND=0";
      }
      if (preset === "WEEKLY") {
        return "FREQ=WEEKLY;BYDAY=MO;BYHOUR=3;BYMINUTE=0;BYSECOND=0";
      }
      if (preset === "MONTHLY") {
        return "FREQ=MONTHLY;BYMONTHDAY=1;BYHOUR=3;BYMINUTE=0;BYSECOND=0";
      }
      return "";
    };

    const renderHistory = async (scheduleId, name) => {
      const tableBody = ui.qs("#history-table tbody");
      const emptyEl = ui.qs("#history-empty");
      ui.qs("#history-title").textContent = name || scheduleId || "未選択";
      tableBody.innerHTML = "";
      if (!scheduleId) {
        emptyEl.style.display = "block";
        return;
      }
      const response = await app.apiFetchSafe(`/api/schedules/${encodeURIComponent(scheduleId)}/history?limit=50`);
      if (!response.ok) {
        emptyEl.textContent = "取得に失敗しました";
        emptyEl.style.display = "block";
        return;
      }
      const history = response.data.history || [];
      if (!history.length) {
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";
      history.forEach((item) => {
        const row = ui.el("tr");
        row.appendChild(ui.el("td", { text: item.run_id }));
        row.appendChild(ui.el("td", { text: item.status || "-" }));
        row.appendChild(ui.el("td", { text: item.attempts || 0 }));
        row.appendChild(ui.el("td", { text: item.error || "-" }));
        row.appendChild(ui.el("td", { text: item.updated_at || "-" }));
        tableBody.appendChild(row);
      });
    };

    const renderSchedules = async () => {
      const tableBody = ui.qs("#schedule-table tbody");
      const emptyEl = ui.qs("#schedule-empty");
      tableBody.innerHTML = "";
      const response = await app.apiFetchSafe("/api/schedules");
      if (!response.ok) {
        emptyEl.textContent = "未実装/未接続";
        emptyEl.style.display = "block";
        return;
      }
      const list = response.data.schedules || [];
      if (!list.length) {
        emptyEl.textContent = "データがありません";
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";
      list.forEach((item) => {
        const row = ui.el("tr");
        row.appendChild(ui.el("td", { text: item.name || "-" }));
        const enabledCell = ui.el("td");
        const toggle = ui.el("input", { type: "checkbox" });
        toggle.checked = Boolean(item.enabled);
        toggle.addEventListener("change", async () => {
          await app.apiFetchSafe(`/api/schedules/${encodeURIComponent(item.schedule_id)}`, {
            method: "PATCH",
            body: { enabled: toggle.checked },
          });
          renderSchedules();
        });
        enabledCell.appendChild(toggle);
        row.appendChild(enabledCell);
        row.appendChild(ui.el("td", { text: item.next_run_at || "-" }));
        row.appendChild(ui.el("td", { text: item.last_run_at || "-" }));
        row.appendChild(ui.el("td", { text: item.last_status || "-" }));
        const actions = ui.el("td");
        const runButton = ui.el("button", { text: "Run now" });
        runButton.addEventListener("click", async () => {
          await app.apiFetchSafe(`/api/schedules/${encodeURIComponent(item.schedule_id)}/run?force=true`, {
            method: "POST",
          });
          renderSchedules();
          renderHistory(item.schedule_id, item.name);
        });
        const historyButton = ui.el("button", { text: "History", className: "secondary" });
        historyButton.addEventListener("click", () => renderHistory(item.schedule_id, item.name));
        actions.appendChild(runButton);
        actions.appendChild(historyButton);
        row.appendChild(actions);
        tableBody.appendChild(row);
      });
    };

    const init = () => {
      setActiveNav();
      renderSchedules();
      ui.qs("#refresh-schedule").addEventListener("click", renderSchedules);
      ui.qs("#schedule-rrule-preset").addEventListener("change", (event) => {
        const preset = event.target.value;
        const rrule = presetToRrule(preset);
        if (rrule) {
          ui.qs("#schedule-rrule").value = rrule;
        }
      });
      ui.qs("#create-schedule").addEventListener("click", async () => {
        const payload = {
          name: ui.qs("#schedule-name").value,
          timezone: ui.qs("#schedule-timezone").value,
          rrule: ui.qs("#schedule-rrule").value,
          query: {
            keywords: ui
              .qs("#schedule-keywords")
              .value.split(",")
              .map((item) => item.trim())
              .filter(Boolean),
            date_range_days: Number(ui.qs("#schedule-date-range").value || 30),
            max_papers: Number(ui.qs("#schedule-max-papers").value || 50),
            oa_only: ui.qs("#schedule-oa-only").value === "true",
            oa_policy: ui.qs("#schedule-oa-policy").value,
          },
          outputs: {
            generate_notes: ui.qs("#schedule-output-notes").checked,
            generate_package_zip: ui.qs("#schedule-output-zip").checked,
            generate_submission_package: ui.qs("#schedule-output-submission").checked,
          },
          limits: {
            max_runtime_minutes: Number(ui.qs("#schedule-max-runtime").value || 60),
            max_retries: Number(ui.qs("#schedule-max-retries").value || 3),
            cooldown_minutes_after_failure: Number(ui.qs("#schedule-cooldown").value || 30),
          },
        };
        const response = await app.apiFetchSafe("/api/schedules", { method: "POST", body: payload });
        ui.qs("#schedule-create-status").textContent = response.ok ? "作成完了" : "作成失敗";
        renderSchedules();
      });
    };

    init();
  </script>
</body>
</html>
