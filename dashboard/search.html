<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Search Studio - Research OS Dashboard</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body data-page="search">
  <nav class="top-nav">
    <a href="index.html">Home</a>
    <a href="runs.html">Runs</a>
    <a href="search.html">Search</a>
    <a href="schedule.html">Schedule</a>
    <a href="feedback.html">Feedback Risk</a>
    <a href="decision.html">Decision</a>
    <a href="finance.html">Finance</a>
    <a href="settings.html">Settings</a>
  </nav>
  <main class="container">
    <header class="page-header">
      <h1>Search Studio</h1>
      <p>Hybrid Retrieval v2 (Vector + Keyword + Filters + Provenance)</p>
    </header>

    <section class="panel">
      <div class="section-title">
        <h2>Search</h2>
        <div class="flex">
          <button id="refresh-status" class="secondary">Index Status</button>
          <button id="rebuild-index" class="secondary">Rebuild</button>
          <button id="update-index" class="secondary">Update</button>
        </div>
      </div>
      <div id="index-status" class="notice">Checking index status...</div>
      <div class="form-row">
        <input id="search-query" placeholder="Search query" />
        <select id="search-mode">
          <option value="hybrid">hybrid</option>
          <option value="vector">vector</option>
          <option value="keyword">keyword</option>
        </select>
        <input id="search-topk" type="number" min="1" max="200" value="20" />
        <button id="search-submit">Search</button>
      </div>
      <div class="grid cols-3">
        <div>
          <label>Year From</label>
          <input id="filter-year-from" type="number" placeholder="2019" />
        </div>
        <div>
          <label>Year To</label>
          <input id="filter-year-to" type="number" placeholder="2024" />
        </div>
        <div>
          <label>Tier (comma)</label>
          <input id="filter-tier" placeholder="S,A" />
        </div>
        <div>
          <label>OA (comma)</label>
          <input id="filter-oa" placeholder="gold,green" />
        </div>
        <div>
          <label>Topics (comma)</label>
          <input id="filter-topics" placeholder="CD73,adenosine" />
        </div>
        <div>
          <label>Source Type (comma)</label>
          <input id="filter-source-type" placeholder="kb_topic,claim" />
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="section-title">
        <h2>Saved Queries</h2>
        <div class="flex">
          <input id="save-name" placeholder="Saved query name" />
          <button id="save-query">Save</button>
        </div>
      </div>
      <div id="saved-queries" class="notice">Loading...</div>
    </section>

    <section class="panel">
      <div class="section-title">
        <h2>Export</h2>
        <div class="flex">
          <button id="export-json" class="secondary">Export JSON</button>
          <button id="export-csv" class="secondary">Export CSV</button>
          <button id="export-md" class="secondary">Export MD</button>
        </div>
      </div>
      <div id="export-status" class="notice">No export yet.</div>
    </section>

    <section class="panel">
      <div class="section-title">
        <h2>Results</h2>
      </div>
      <div id="search-results" class="grid cols-2"></div>
    </section>
  </main>

  <script src="assets/app.js"></script>
  <script>
    const statusEl = document.getElementById("index-status");
    const resultsEl = document.getElementById("search-results");
    const savedQueriesEl = document.getElementById("saved-queries");
    const exportStatus = document.getElementById("export-status");

    const getFilters = () => {
      const yearFrom = document.getElementById("filter-year-from").value;
      const yearTo = document.getElementById("filter-year-to").value;
      const tier = document.getElementById("filter-tier").value;
      const oa = document.getElementById("filter-oa").value;
      const topics = document.getElementById("filter-topics").value;
      const sourceType = document.getElementById("filter-source-type").value;
      const filters = {};
      if (yearFrom) filters.year_from = Number(yearFrom);
      if (yearTo) filters.year_to = Number(yearTo);
      if (tier) filters.tier_in = tier.split(",").map((v) => v.trim()).filter(Boolean);
      if (oa) filters.oa_in = oa.split(",").map((v) => v.trim()).filter(Boolean);
      if (topics) filters.topics_any = topics.split(",").map((v) => v.trim()).filter(Boolean);
      if (sourceType) filters.source_type_in = sourceType.split(",").map((v) => v.trim()).filter(Boolean);
      return filters;
    };

    const buildPayload = () => {
      const query = document.getElementById("search-query").value;
      const mode = document.getElementById("search-mode").value;
      const topK = Number(document.getElementById("search-topk").value || 20);
      return { query, mode, top_k: topK, filters: getFilters() };
    };

    const renderResults = (results) => {
      resultsEl.innerHTML = "";
      if (!results.length) {
        resultsEl.innerHTML = '<div class="notice">No results.</div>';
        return;
      }
      results.forEach((item) => {
        const card = document.createElement("div");
        card.className = "card";
        const badges = [item.meta?.tier, item.meta?.year, item.meta?.oa].filter(Boolean).join(" Â· ");
        card.innerHTML = `
          <h3>${item.title || "Untitled"}</h3>
          <p>${item.snippet || ""}</p>
          <p><strong>Score:</strong> ${item.score.toFixed(3)}</p>
          <p><strong>Provenance:</strong> ${item.provenance?.section || ""} ${item.provenance?.locator || ""}</p>
          <p class="badge">${badges}</p>
          <div class="flex">
            <a class="secondary" href="${item.jump_link?.url || '#'}" target="_blank">Open</a>
            <button class="secondary copy-locator">Copy locator</button>
          </div>
        `;
        card.querySelector(".copy-locator").addEventListener("click", () => {
          const locator = item.provenance?.locator || "";
          if (!locator) return;
          navigator.clipboard.writeText(locator).then(
            () => {
              exportStatus.textContent = "Locator copied.";
            },
            () => {
              window.prompt("Copy locator", locator);
            }
          );
        });
        resultsEl.appendChild(card);
      });
    };

    const refreshStatus = async () => {
      statusEl.textContent = "Loading...";
      const result = await app.apiFetchSafe("/api/index/v2/status");
      if (!result.ok) {
        statusEl.textContent = result.error.message;
        return;
      }
      if (!result.data.available) {
        statusEl.textContent = "Index not built yet.";
        return;
      }
      statusEl.textContent = `Indexed chunks: ${result.data.manifest?.chunks || 0} | Model: ${result.data.manifest?.embedding_model || ""}`;
    };

    const loadSavedQueries = async () => {
      savedQueriesEl.textContent = "Loading...";
      const result = await app.apiFetchSafe("/api/queries");
      if (!result.ok) {
        savedQueriesEl.textContent = result.error.message;
        return;
      }
      const items = result.data.items || [];
      if (!items.length) {
        savedQueriesEl.textContent = "No saved queries.";
        return;
      }
      savedQueriesEl.innerHTML = "";
      items.forEach((item) => {
        const row = document.createElement("div");
        row.className = "card";
        row.innerHTML = `<strong>${item.name}</strong><div class="flex"><button class="secondary load">Load</button><button class="secondary delete">Delete</button></div>`;
        row.querySelector(".load").addEventListener("click", async () => {
          const payload = item.payload;
          document.getElementById("search-query").value = payload.query || "";
          document.getElementById("search-mode").value = payload.mode || "hybrid";
          document.getElementById("search-topk").value = payload.top_k || 20;
          await runSearch(payload);
        });
        row.querySelector(".delete").addEventListener("click", async () => {
          await app.apiFetchSafe(`/api/queries/${item.id}`, { method: "DELETE" });
          loadSavedQueries();
        });
        savedQueriesEl.appendChild(row);
      });
    };

    const runSearch = async (overridePayload = null) => {
      resultsEl.innerHTML = '<div class="notice">Searching...</div>';
      const payload = overridePayload || buildPayload();
      const result = await app.apiFetchSafe("/api/search/v2", { method: "POST", body: payload });
      if (!result.ok) {
        resultsEl.innerHTML = `<div class="notice">${result.error.message}</div>`;
        return;
      }
      if (result.data.error) {
        resultsEl.innerHTML = `<div class="notice">${result.data.error}</div>`;
        return;
      }
      renderResults(result.data.results || []);
    };

    const exportResults = async (format) => {
      exportStatus.textContent = "Exporting...";
      const payload = buildPayload();
      payload.format = format;
      const result = await app.apiFetchSafe("/api/search/v2/export", { method: "POST", body: payload });
      if (!result.ok) {
        exportStatus.textContent = result.error.message;
        return;
      }
      if (result.data.error) {
        exportStatus.textContent = result.data.error;
        return;
      }
      const blob = new Blob([result.data], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `search_export.${format}`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      exportStatus.textContent = "Export ready.";
      URL.revokeObjectURL(url);
    };

    document.getElementById("search-submit").addEventListener("click", () => runSearch());
    document.getElementById("refresh-status").addEventListener("click", refreshStatus);
    document.getElementById("rebuild-index").addEventListener("click", async () => {
      await app.apiFetchSafe("/api/index/v2/rebuild", { method: "POST", body: {} });
      refreshStatus();
    });
    document.getElementById("update-index").addEventListener("click", async () => {
      await app.apiFetchSafe("/api/index/v2/update", { method: "POST", body: {} });
      refreshStatus();
    });
    document.getElementById("save-query").addEventListener("click", async () => {
      const name = document.getElementById("save-name").value;
      if (!name) return;
      const payload = buildPayload();
      await app.apiFetchSafe("/api/queries", { method: "POST", body: { name, payload } });
      document.getElementById("save-name").value = "";
      loadSavedQueries();
    });
    document.getElementById("export-json").addEventListener("click", () => exportResults("json"));
    document.getElementById("export-csv").addEventListener("click", () => exportResults("csv"));
    document.getElementById("export-md").addEventListener("click", () => exportResults("md"));

    refreshStatus();
    loadSavedQueries();
  </script>
</body>
</html>
